<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>星之声 - 登录/注册</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "微软雅黑", sans-serif;
        }
        body {
            background-color: #f5f5f5;
            padding: 50px;
        }
        /* 通用容器样式 */
        .auth-container {
            width: 400px;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 25px;
            margin: 0 auto;
            display: block;
        }
        .register-container {
            display: none; /* 默认隐藏注册界面 */
        }
        /* 标题栏 */
        .auth-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            position: relative;
        }
        .close-btn {
            position: absolute;
            right: 0;
            top: 0;
            cursor: pointer;
            font-size: 18px;
            color: #999;
        }
        /* 输入框组 */
        .input-group {
            margin-bottom: 15px;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }
        .input-group input {
            width: 100%;
            height: 40px;
            padding: 0 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            outline: none;
            transition: border-color 0.3s;
        }
        .input-group input:focus {
            border-color: #FF9933;
        }
        /* 错误提示样式 */
        .error-tip {
            color: #ff4444;
            font-size: 12px;
            margin-top: 5px;
            display: none;
        }
        .input-group.error input {
            border-color: #ff4444;
        }
        .input-group.error .error-tip {
            display: block;
        }
        /* 辅助操作栏 */
        .helper-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 14px;
        }
        .remember-me {
            display: flex;
            align-items: center;
        }
        .remember-me input {
            margin-right: 5px;
        }
        .forget-pwd {
            color: #FF9933;
            cursor: pointer;
            text-decoration: none;
        }
        /* 按钮样式 */
        .auth-btn {
            width: 100%;
            height: 45px;
            background-color: #FF9933;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .auth-btn:hover {
            background-color: #e68a2e;
        }
        .auth-btn:disabled {
            background-color: #ffcc99;
            cursor: not-allowed;
        }
        /* 其他登录方式 */
        .other-login {
            text-align: center;
            margin: 20px 0;
            color: #999;
            font-size: 14px;
        }
        .login-icons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        .login-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            cursor: pointer;
            font-size: 16px;
        }
        .login-icon.wechat {
            color: #07c160;
        }
        .login-icon.qq {
            color: #12b7f5;
        }
        /* 切换链接 */
        .switch-link {
            text-align: center;
            margin-top: 15px;
            font-size: 14px;
            color: #999;
        }
        .switch-link a {
            color: #FF9933;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- 登录界面 -->
    <div class="auth-container login-container">
        <div class="auth-title">
            登录星之声
            <span class="close-btn">×</span>
        </div>
        <!-- 登录界面：用户名改为手机号 -->
        <div class="input-group" id="login-phone-group">
            <label>手机号</label>
            <input type="tel" id="login-phone" placeholder="请输入手机号">
            <div class="error-tip" id="login-phone-tip">请输入有效的手机号</div>
        </div>
        <div class="input-group" id="login-pwd-group">
            <label>密码</label>
            <input type="password" id="login-pwd" placeholder="请输入密码">
            <div class="error-tip" id="login-pwd-tip">密码长度不能少于6位</div>
        </div>
        <div class="helper-bar">
            <div class="remember-me">
                <input type="checkbox" id="remember">
                <label for="remember">记住我</label>
            </div>
            <a class="forget-pwd">忘记密码?</a>
        </div>
        <button class="auth-btn" id="login-btn">登录</button>
        <div class="other-login">
            其他登录方式
            <div class="login-icons">
                <div class="login-icon wechat">微</div>
                <div class="login-icon qq">Q</div>
            </div>
        </div>
        <div class="switch-link">
            没有账号? <a class="to-register">立即注册</a>
        </div>
    </div>

    <!-- 注册界面 -->
    <div class="auth-container register-container">
        <div class="auth-title">
            注册星之声
            <span class="close-btn">×</span>
        </div>
        <div class="input-group" id="reg-username-group">
            <label>用户名</label>
            <input type="text" id="reg-username" placeholder="请输入用户名（3-10位）">
            <div class="error-tip" id="reg-username-tip">用户名长度需在3-10位之间</div>
        </div>
        <!-- 注册界面：邮箱改为手机号 -->
        <div class="input-group" id="reg-phone-group">
            <label>手机号</label>
            <input type="tel" id="reg-phone" placeholder="请输入手机号">
            <div class="error-tip" id="reg-phone-tip">请输入有效的手机号</div>
        </div>
        <div class="input-group" id="reg-pwd-group">
            <label>密码</label>
            <input type="password" id="reg-pwd" placeholder="请输入密码（不少于6位）">
            <div class="error-tip" id="reg-pwd-tip">密码长度不能少于6位</div>
        </div>
        <div class="input-group" id="reg-repwd-group">
            <label>确认密码</label>
            <input type="password" id="reg-repwd" placeholder="请再次输入密码">
            <div class="error-tip" id="reg-repwd-tip">两次输入的密码不一致</div>
        </div>
        <button class="auth-btn" id="reg-btn">注册</button>
        <div class="switch-link">
            已有账号? <a class="to-login">立即登录</a>
        </div>
    </div>

    <script>
        // 获取元素
        const loginContainer = document.querySelector('.login-container');
        const registerContainer = document.querySelector('.register-container');
        const toRegisterLink = document.querySelector('.to-register');
        const toLoginLink = document.querySelector('.to-login');
        const closeBtns = document.querySelectorAll('.close-btn');

        // 登录表单元素（用户名改为手机号）
        const loginPhone = document.getElementById('login-phone');
        const loginPwd = document.getElementById('login-pwd');
        const loginBtn = document.getElementById('login-btn');
        const loginPhoneGroup = document.getElementById('login-phone-group');
        const loginPwdGroup = document.getElementById('login-pwd-group');

        // 注册表单元素（邮箱改为手机号）
        const regUsername = document.getElementById('reg-username');
        const regPhone = document.getElementById('reg-phone');
        const regPwd = document.getElementById('reg-pwd');
        const regRepwd = document.getElementById('reg-repwd');
        const regBtn = document.getElementById('reg-btn');
        const regUsernameGroup = document.getElementById('reg-username-group');
        const regPhoneGroup = document.getElementById('reg-phone-group');
        const regPwdGroup = document.getElementById('reg-pwd-group');
        const regRepwdGroup = document.getElementById('reg-repwd-group');

        // 切换到注册界面
        toRegisterLink.addEventListener('click', () => {
            loginContainer.style.display = 'none';
            registerContainer.style.display = 'block';
            // 清空登录表单错误状态
            clearLoginErrors();
        });

        // 切换到登录界面
        toLoginLink.addEventListener('click', () => {
            registerContainer.style.display = 'none';
            loginContainer.style.display = 'block';
            // 清空注册表单错误状态
            clearRegErrors();
        });

        // 关闭按钮
        closeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                btn.closest('.auth-container').style.display = 'none';
                // 清空错误状态
                clearLoginErrors();
                clearRegErrors();
            });
        });

        // 登录表单验证
        loginPhone.addEventListener('blur', validateLoginPhone);
        loginPwd.addEventListener('blur', validateLoginPwd);
        loginBtn.addEventListener('click', handleLogin);

        // 注册表单验证
        regUsername.addEventListener('blur', validateRegUsername);
        regPhone.addEventListener('blur', validateRegPhone);
        regPwd.addEventListener('blur', validateRegPwd);
        regRepwd.addEventListener('blur', validateRegRepwd);
        regBtn.addEventListener('click', handleRegister);

        // 验证登录手机号（新增）
        function validateLoginPhone() {
            const phoneReg = /^1[3-9]\d{9}$/; // 手机号正则：11位数字，以1开头，第二位3-9
            if (!phoneReg.test(loginPhone.value.trim())) {
                loginPhoneGroup.classList.add('error');
                return false;
            }
            loginPhoneGroup.classList.remove('error');
            return true;
        }

        // 验证登录密码
        function validateLoginPwd() {
            if (loginPwd.value.length < 6) {
                loginPwdGroup.classList.add('error');
                return false;
            }
            loginPwdGroup.classList.remove('error');
            return true;
        }

        // 验证注册用户名
        function validateRegUsername() {
            const val = regUsername.value.trim();
            if (val.length < 3 || val.length > 10) {
                regUsernameGroup.classList.add('error');
                return false;
            }
            regUsernameGroup.classList.remove('error');
            return true;
        }

        // 验证注册手机号（原邮箱验证修改）
        function validateRegPhone() {
            const phoneReg = /^1[3-9]\d{9}$/;
            if (!phoneReg.test(regPhone.value.trim())) {
                regPhoneGroup.classList.add('error');
                return false;
            }
            regPhoneGroup.classList.remove('error');
            return true;
        }

        // 验证注册密码
        function validateRegPwd() {
            if (regPwd.value.length < 6) {
                regPwdGroup.classList.add('error');
                return false;
            }
            regPwdGroup.classList.remove('error');
            return true;
        }

        // 验证确认密码
        function validateRegRepwd() {
            if (regRepwd.value !== regPwd.value) {
                regRepwdGroup.classList.add('error');
                return false;
            }
            regRepwdGroup.classList.remove('error');
            return true;
        }

        // 处理登录提交
        async function handleLogin() {
            const isPhoneValid = validateLoginPhone();
            const isPwdValid = validateLoginPwd();

            if (isPhoneValid && isPwdValid) {
                try {
                    // 发送真实登录请求
                    const response = await fetch('http://localhost:3000/api/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            email: loginPhone.value.trim(), // 注意：后端使用email字段，但前端输入的是手机号
                            password: loginPwd.value
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 登录成功，存储令牌
                        localStorage.setItem('authToken', data.token);
                        alert(`登录成功！欢迎回来！`);
                        
                        // 跳转到主页或上传页面
                        window.location.href = '../html/upload-audio.html';
                    } else {
                        // 登录失败
                        alert(`登录失败: ${data.message || '用户名或密码错误'}`);
                    }
                } catch (error) {
                    console.error('登录请求失败:', error);
                    alert('登录失败，请检查网络连接或稍后重试');
                }
            }
        }

        // 处理注册提交
        async function handleRegister() {
            const isUsernameValid = validateRegUsername();
            const isPhoneValid = validateRegPhone();
            const isPwdValid = validateRegPwd();
            const isRepwdValid = validateRegRepwd();

            if (isUsernameValid && isPhoneValid && isPwdValid && isRepwdValid) {
                try {
                    // 发送真实注册请求
                    const response = await fetch('http://localhost:3000/api/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            username: regUsername.value.trim(),
                            email: regPhone.value.trim(), // 注意：后端使用email字段，但前端输入的是手机号
                            password: regPwd.value
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        // 注册成功
                        alert(`注册成功！请登录`);
                        
                        // 清空表单并切换到登录界面
                        regUsername.value = '';
                        regPhone.value = '';
                        regPwd.value = '';
                        regRepwd.value = '';
                        registerContainer.style.display = 'none';
                        loginContainer.style.display = 'block';
                        loginPhone.value = regPhone.value; // 自动填充手机号
                    } else {
                        // 注册失败
                        alert(`注册失败: ${data.message || '注册信息无效'}`);
                    }
                } catch (error) {
                    console.error('注册请求失败:', error);
                    alert('注册失败，请检查网络连接或稍后重试');
                }
            }
        }

        // 清空登录表单错误
        function clearLoginErrors() {
            loginPhoneGroup.classList.remove('error');
            loginPwdGroup.classList.remove('error');
            loginPhone.value = '';
            loginPwd.value = '';
        }

        // 清空注册表单错误
        function clearRegErrors() {
            regUsernameGroup.classList.remove('error');
            regPhoneGroup.classList.remove('error');
            regPwdGroup.classList.remove('error');
            regRepwdGroup.classList.remove('error');
            regUsername.value = '';
            regPhone.value = '';
            regPwd.value = '';
            regRepwd.value = '';
        }
    </script>
</body>
</html>