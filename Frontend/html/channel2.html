<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­å­¦ä¹ ç¾¤ç»„ - æ˜Ÿä¹‹å£°</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/channel2.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../js/search.js"></script>
    <style>
        /* ç»Ÿä¸€æ©™è‰²ä¸»é¢˜æ ·å¼ */
        :root {
            --orange-primary: #ff6b35;
            --orange-light: #ff9d6f;
            --orange-dark: #d85623;
            --orange-gradient: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
            --gray-light: #f5f5f5;
            --gray-border: #e0e0e0;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #999999;
        }
        
        /* ä¸»å†…å®¹åŒºæ ·å¼ */
        .main.channel-main {
            padding: 20px 0;
            background: #f9f9f9;
            min-height: calc(100vh - 120px);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        /* ç¾¤èŠå¸ƒå±€æ ·å¼ */
        .channel-layout {
            display: flex;
            gap: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: 600px;
        }
        
        /* å·¦ä¾§ç¾¤ç»„åˆ—è¡¨ */
        .channel-sidebar {
            width: 280px;
            background: white;
            padding: 20px 0;
            border-right: 1px solid var(--gray-border);
        }
        
        .channel-search {
            padding: 0 20px 20px 20px;
            border-bottom: 1px solid var(--gray-border);
        }
        
        .search-wrapper {
            display: flex;
            align-items: center;
            background: var(--gray-light);
            border-radius: 8px;
            padding: 8px 12px;
        }
        
        .search-wrapper i {
            color: var(--text-light);
            margin-right: 8px;
        }
        
        .channel-search-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            color: var(--text-primary);
        }
        
        .channel-search-input::placeholder {
            color: var(--text-light);
        }
        
        .create-group-btn {
            margin: 20px;
            width: calc(100% - 40px);
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .create-group-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }
        
        /* ç¾¤ç»„åˆ—è¡¨é¡¹ - å¯ç‚¹å‡»æ ·å¼ */
        .group-item {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border-bottom: 1px solid var(--gray-border);
            text-decoration: none;
            color: inherit;
        }
        
        .group-item:last-child {
            border-bottom: none;
        }
        
        .group-item:hover {
            background: var(--gray-light);
            transform: translateX(5px);
        }
        
        .group-item.active {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
        }
        
        .group-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: white;
        }
        
        .group-item img {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 12px;
            border: 2px solid white;
        }
        
        .group-item.active img {
            border-color: white;
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3);
        }
        
        .group-info {
            flex: 1;
            min-width: 0;
        }
        
        .group-info h4 {
            margin: 0 0 4px 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .group-item.active .group-info h4 {
            color: white;
            font-weight: 700;
        }
        
        .group-info p {
            margin: 0;
            font-size: 12px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .group-item.active .group-info p {
            color: rgba(255, 255, 255, 0.9);
        }
        
        .message-count {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
            color: white;
            font-size: 11px;
            font-weight: 600;
            min-width: 18px;
            height: 18px;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }
        
        .group-item.active .message-count {
            background: white;
            color: #ff6b35;
        }
        
        .message-time {
            font-size: 11px;
            color: var(--text-light);
            margin-left: 5px;
        }
        
        .group-item.active .message-time {
            color: rgba(255, 255, 255, 0.8);
        }
        
        .group-list-mobile {
            display: none;
        }
        
        /* ä¸­é—´èŠå¤©åŒºåŸŸ */
        .group-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        .group-header {
            padding: 20px;
            border-bottom: 1px solid var(--gray-border);
            background: white;
            position: relative;
        }
        
        .group-header h2 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .group-header h2::before {
            content: '\f0c0';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            color: var(--orange-primary);
        }
        
        .group-stats {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .member-count {
            font-size: 13px;
            color: var(--text-secondary);
            background: var(--gray-light);
            padding: 4px 10px;
            border-radius: 12px;
        }
        
        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ - æ¨¡ä»¿å›¾ç‰‡æ ¼å¼ */
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        /* æ¶ˆæ¯é¡¹åŸºæœ¬æ ·å¼ */
        .message-item {
            display: flex;
            position: relative;
        }
        
        .message-item.other-message {
            flex-direction: row;
        }
        
        .message-item.own-message {
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: white;
            flex-shrink: 0;
            margin: 0 10px;
        }
        
        .other-message .message-avatar {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
        }
        
        .own-message .message-avatar {
            background: linear-gradient(135deg, #4285F4 0%, #8AB4F8 100%);
        }
        
        .message-content-wrapper {
            max-width: 65%;
            display: flex;
            flex-direction: column;
        }
        
        .other-message .message-content-wrapper { align-items: flex-start; }
        .own-message .message-content-wrapper { align-items: flex-end; }
        
        .message-info {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            gap: 8px;
        }
        
        .message-sender { font-size: 13px; font-weight: 600; color: var(--text-primary); }
        .message-time { font-size: 11px; color: var(--text-light); }
        
        .message-bubble {
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            max-width: 100%;
            word-break: break-word;
            line-height: 1.5;
            min-width: 60px;
        }
        
        .other-message .message-bubble {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%);
            color: white;
            border-top-left-radius: 4px;
        }
        .own-message .message-bubble {
            background: white;
            color: #ff6b35;
            border: 1px solid #ff6b35;
            border-top-right-radius: 4px;
        }
        .other-message .message-bubble::before {
            content: '';
            position: absolute;
            left: -8px; top: 14px;
            border-top: 6px solid transparent;
            border-right: 8px solid #ff6b35;
            border-bottom: 6px solid transparent;
        }
        .own-message .message-bubble::before {
            content: '';
            position: absolute;
            right: -8px; top: 14px;
            border-top: 6px solid transparent;
            border-left: 8px solid #ff6b35;
            border-bottom: 6px solid transparent;
        }
        
        .message-text { font-size: 14px; line-height: 1.5; }
        .english-text { letter-spacing: 0.3px; }
        .bilingual-text { line-height: 1.6; }
        
        .system-message { display: flex; justify-content: center; margin: 8px 0; }
        .system-message .message-bubble {
            background: #f0f0f0; color: var(--text-secondary);
            font-size: 12px; padding: 6px 12px; border-radius: 12px; max-width: 80%; text-align: center;
        }
        .system-message .message-bubble::before { display: none; }
        
        .vocabulary-highlight {
            color: #4285F4; font-weight: 600;
            background: rgba(66, 133, 244, 0.1); padding: 2px 6px; border-radius: 4px; margin: 0 2px;
        }
        .grammar-note {
            font-style: italic; color: #666; font-size: 12px; margin-top: 4px;
            border-left: 3px solid #ff6b35; padding-left: 8px;
        }
        
        .group-switch-indicator {
            position: absolute; top: 20px; right: 20px;
            background: rgba(255, 255, 255, 0.95); color: #ff6b35;
            padding: 8px 15px; border-radius: 20px; font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10; animation: fadeInOut 2s ease;
        }
        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(-10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-10px); }
        }
        .group-switch-indicator i { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg);} to { transform: rotate(360deg);} }
        
        .message-input-area {
            padding: 20px; border-top: 1px solid var(--gray-border);
            background: white; display: flex; align-items: flex-end; gap: 10px;
        }
        .message-input-controls { display: flex; gap: 8px; }
        .voice-btn, .emoji-btn {
            width: 36px; height: 36px; border-radius: 50%;
            border: 1px solid var(--gray-border); background: white; color: var(--orange-primary);
            cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .voice-btn:hover, .emoji-btn:hover { background: var(--gray-light); }
        .message-input {
            flex: 1; min-height: 40px; max-height: 120px; padding: 10px 15px;
            border: 1px solid var(--gray-border); border-radius: 20px; font-size: 14px; resize: none; font-family: inherit;
        }
        .message-input:focus { outline: none; border-color: var(--orange-primary); }
        .send-btn {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%); color: white; border: none;
            border-radius: 20px; padding: 10px 25px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease;
        }
        .send-btn:hover { background: linear-gradient(135deg, #ff9d6f 0%, #ffbc9a 100%); }
        
        .group-info-sidebar { width: 260px; background: white; border-left: 1px solid var(--gray-border); display: flex; flex-direction: column; }
        .group-info-header { padding: 20px; border-bottom: 1px solid var(--gray-border); display: flex; gap: 10px; }
        .group-search-btn, .group-files-btn {
            flex: 1; background: white; border: 1px solid var(--gray-border); border-radius: 6px; padding: 8px 12px;
            color: var(--orange-primary); font-size: 13px; cursor: pointer; transition: all 0.3s ease;
        }
        .group-search-btn:hover, .group-files-btn:hover { background: var(--gray-light); }
        .group-info-content { flex: 1; padding: 20px; overflow-y: auto; }
        .info-section { margin-bottom: 25px; }
        .info-section h3 {
            font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--gray-border);
        }
        .info-item { margin-bottom: 15px; }
        .info-item h4 { font-size: 12px; color: var(--text-light); margin-bottom: 5px; }
        .info-item p { font-size: 14px; color: var(--text-primary); line-height: 1.5; }
        .member-list { display: flex; flex-direction: column; gap: 10px; }
        .member-item { display: flex; align-items: center; gap: 10px; }
        .member-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%); position: relative;
            display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600;
        }
        .member-avatar.online::after {
            content: ''; position: absolute; bottom: 0; right: 0; width: 8px; height: 8px; background: var(--orange-primary);
            border-radius: 50%; border: 2px solid white;
        }
        .member-name { font-size: 13px; color: var(--text-primary); }
        .invite-code-section { margin-top: 30px; }
        .invite-code {
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%); color: white; text-align: center; padding: 12px;
            border-radius: 8px; font-weight: 600; letter-spacing: 1px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;
        }
        .invite-code:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3); }
        .delete-group-btn {
            margin-top: 10px; padding: 8px 16px; background-color: #ff4d4f; color: white; border: none; border-radius: 4px;
            font-size: 14px; cursor: pointer; transition: background-color 0.3s; width: 100%;
        }
        .delete-group-btn:hover { background-color: #ff7875; }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .channel-layout { flex-direction: column; }
            .channel-sidebar { width: 100%; padding: 15px 0; }
            .group-info-sidebar { width: 100%; }
            .group-items { display: none; }
            .group-list-mobile { display: block; }
            .message-content-wrapper { max-width: 75%; }
            .message-input-area { padding: 15px; }
        }
        
        /* ç§»åŠ¨ç«¯åˆ‡æ¢æŒ‰é’® */
        .mobile-toggle {
            display: none; position: fixed; bottom: 80px; right: 20px; width: 56px; height: 56px; border-radius: 50%;
            background: linear-gradient(135deg, #ff6b35 0%, #ff9d6f 100%); color: white; border: none; cursor: pointer; z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        @media (max-width: 768px) { .mobile-toggle { display: block; } .channel-sidebar, .group-info-sidebar { display: none; } }

        /* ä¸ºå›ºå®šæ’­æ”¾æ é¢„ç•™ç©ºé—´ */
        body { padding-bottom: 96px; }

        /* PlayBarï¼ˆæ¥è‡ª PlayBar.htmlï¼‰æ ·å¼ï¼šå®Œæ•´ä¿ç•™ï¼Œä»…ç”¨äºæ’­æ”¾æ  */
        .pv-player-bar {
          position: fixed; left: 0; right: 0; bottom: 0;
          width: 100%; height: 96px; background: #ffffff;
          border-top: 1px solid #e0e0e0; box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
          z-index: 29999; display: flex; align-items: center; user-select: none; pointer-events: auto;
        }
        .pv-inner {
          width: 100%; max-width: 1200px; margin: 0 auto;
          display: grid;
          grid-template-columns: auto 1fr auto; /* å·¦ä¾§è‡ªé€‚åº”ï¼Œä¸­é—´å æ»¡ï¼Œå³ä¾§è‡ªé€‚åº” */
          align-items: center;
          column-gap: 16px;
          padding: 0 24px;
          height: 100%;
        }
        .pv-left {
          display: inline-flex;
          align-items: center;
          gap: 12px;
          min-width: 240px;
        }
        .pv-cover {
          width: 52px; height: 52px; border-radius: 8px;
          background: #eee no-repeat center/cover;
          box-shadow: 0 2px 6px rgba(0,0,0,0.1);
          flex-shrink: 0;
        }
        .pv-meta {
          display: flex; flex-direction: column; min-width: 0;
        }
        .pv-title {
          font-size: 16px; font-weight: 700; color: #222;
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .pv-artist {
          font-size: 12px; color: #666; margin-top: 2px;
          white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .pv-center {
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          gap: 8px; min-width: 0;
        }
        .pv-controls {
          display: inline-flex; align-items: center; gap: 18px;
        }
        .ctrl-btn, .mode-btn, .rate-btn {
          background: transparent; border: none; cursor: pointer; color: #444;
          font-size: 18px; padding: 6px; display: inline-flex; align-items: center; justify-content: center; transition: color 0.2s;
        }
        .ctrl-btn:hover, .mode-btn:hover, .rate-btn:hover { color: #ff8c00; }
        .play-btn {
          width: 44px; height: 44px; border-radius: 50%; background: #ff8c00; color: #fff; border: none;
          display: inline-flex; align-items: center; justify-content: center; cursor: pointer;
          box-shadow: 0 4px 10px rgba(255,140,0,0.30); transition: transform 0.1s, background 0.2s;
        }
        .play-btn:hover { background: #e67e00; transform: scale(1.05); }
        .icon { width: 18px; height: 18px; fill: currentColor; }

        .pv-progress-row { display: flex; align-items: center; gap: 12px; width: 100%; }
        .time.small { font-size: 12px; color: #888; width: 48px; text-align: center; font-variant-numeric: tabular-nums; }
        .pv-progress { position: relative; flex: 1; height: 6px; background: #eee; border-radius: 3px; cursor: pointer; touch-action: none; }
        .pv-progress::before { content: ''; position: absolute; top: -10px; bottom: -10px; left: 0; right: 0; z-index: 1; }
        .pv-progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: #ff8c00; border-radius: 3px; width: 0%; pointer-events: none; }
        .pv-knob { position: absolute; top: 50%; right: -6px; transform: translateY(-50%); width: 12px; height: 12px; background: #fff; border: 2px solid #ff8c00; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .pv-progress:hover .pv-knob, .pv-progress.dragging .pv-knob { opacity: 1; }

        .pv-right {
          display: inline-flex; align-items: center; justify-content: flex-end;
          gap: 12px; min-width: 240px;
        }
        .pv-volume { width: 140px; height: 20px; display: flex; align-items: center; cursor: pointer; position: relative; }
        .pv-volume-bar { width: 100%; height: 4px; background: #eee; border-radius: 2px; position: relative; overflow: visible; pointer-events: none; }
        .pv-volume-fill { height: 100%; background: #888; width: 50%; border-radius: 2px; position: relative; }
        .pv-volume-fill::after { content: ''; position: absolute; right: -5px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: #fff; border: 1px solid #888; border-radius: 50%; opacity: 0; transition: opacity 0.2s; }
        .pv-volume:hover .pv-volume-fill::after { opacity: 1; }

        /* å¼¹å±‚ï¼šå¾ªç¯æ¨¡å¼ä¸å€é€Ÿèœå• */
        .popover {
          position: absolute; bottom: 100%;
          left: 50%; transform: translateX(-50%);
          background: #fff; border: 1px solid #ddd; border-radius: 8px;
          box-shadow: 0 10px 24px rgba(0,0,0,0.12);
          padding: 8px; z-index: 30000; display: none;
        }
        .popover.show { display: flex; }
        .mode-popover { gap: 10px; align-items: center; }
        .mode-item {
          width: 40px; height: 40px; border-radius: 8px; border: 1px solid #eee;
          display: inline-flex; align-items: center; justify-content: center; cursor: pointer; color: #444;
        }
        .mode-item:hover { color: #ff8c00; border-color: #ffeed6; background: #fff9f0; }
        .mode-item.active { color: #fff; background: #ff8c00; border-color: #ff8c00; }
        .rate-popover { flex-direction: column; min-width: 140px; }
        .rate-item { padding: 8px 12px; font-size: 14px; color: #333; cursor: pointer; border-radius: 6px; }
        .rate-item:hover { background: #f7f7f7; }
        .rate-item.active { color: #ff8c00; font-weight: 700; background: #fff4e6; }

        @media (max-width: 900px) {
          .pv-left { min-width: 0; }
          .pv-right { min-width: 0; }
          .pv-inner { grid-template-columns: auto 1fr auto; column-gap: 10px; padding: 0 12px; }
        }
    </style>
</head>
<body>
    <!-- éŸ³é¢‘å…ƒç´ ï¼ˆé¡µé¢å…¶ä»–é€»è¾‘ç”¨ï¼‰ -->
    <audio id="audioPlayer" controls style="display: none;">
        <source src="" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾
    </audio>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="header">
        <div class="logo">
            <div class="logo-img"></div>
            <span class="logo-text">æ˜Ÿä¹‹å£°</span>
        </div>
        <nav class="main-nav">
            <a href="index.html" class="nav-item">é¦–é¡µ</a>
            <a href="category.html" class="nav-item">åˆ†ç±»</a>
            <a href="channel.html" class="nav-item active">ç¤¾åŒº</a>
        </nav>
        <div class="search-box">
            <input type="text" placeholder="æœç´¢è¯¾ç¨‹ã€é¢‘é“..." class="search-input" id="homeSearchInput">
            <button class="search-btn" id="homeSearchBtn"><i class="fas fa-search"></i></button>
        </div>
        <div class="user-functions">
            <a href="my-recent.html" class="func-item">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </a>
            <a href="my-message.html" class="func-item"><i class="fas fa-bell"></i> æ¶ˆæ¯</a>
            <a href="my-collect.html" class="func-item"><i class="fas fa-star"></i> æ”¶è—</a>
            <a href="my-recent.html" class="func-item"><i class="fas fa-history"></i> å†å²</a>
            <a href="my-creator_center.html" class="func-item"><i class="fas fa-pen"></i> åˆ›ä½œä¸­å¿ƒ</a>
            <a href="login.html"><button class="submit-btn">ç™»å½•/æ³¨å†Œ</button></a>
        </div>
    </header>

    <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
    <main class="main channel-main">
        <div class="container">
            <div class="channel-layout">
                <!-- å·¦ä¾§é¢‘é“å¯¼èˆª -->
                <aside class="channel-sidebar">
                    <div class="channel-search">
                        <div class="search-wrapper">
                            <i class="fas fa-search"></i>
                            <input type="text" class="channel-search-input" placeholder="æœç´¢è‹±è¯­ç¾¤ç»„..." id="groupSearch">
                        </div>
                    </div>
                    <button class="create-group-btn" id="createGroupBtn">
                        <i class="fas fa-plus-circle"></i> åˆ›å»ºå­¦ä¹ ç¾¤ç»„
                    </button>

                    <!-- ç§»åŠ¨ç«¯ç¾¤ç»„åˆ—è¡¨ -->
                    <div class="group-list-mobile">
                        <div class="group-item active" data-group-id="1" onclick="switchGroup(1)">
                            <img src="images/english-group1.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>è‹±è¯­å£è¯­ç»ƒä¹ </h4>
                                <p>æœ€æ–°ï¼šDaily conversation practice</p>
                            </div>
                            <span class="message-count">8</span>
                            <span class="message-time">10:30</span>
                        </div>
                        <div class="group-item" data-group-id="2" onclick="switchGroup(2)">
                            <img src="images/english-group2.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>æ‰˜ç¦å¤‡è€ƒç¾¤</h4>
                                <p>æœ€æ–°ï¼šReading comprehension tips</p>
                            </div>
                            <span class="message-time">æ˜¨å¤©</span>
                        </div>
                    </div>

                    <!-- æ¡Œé¢ç«¯ç¾¤ç»„åˆ—è¡¨ -->
                    <div class="group-items">
                        <div class="group-item active" data-group-id="1" onclick="switchGroup(1)">
                            <img src="images/english-group1.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>è‹±è¯­å£è¯­ç»ƒä¹ </h4>
                                <p>æœ€æ–°ï¼šDaily conversation practice</p>
                            </div>
                            <span class="message-count">8</span>
                            <span class="message-time">10:30</span>
                        </div>
                        <div class="group-item" data-group-id="2" onclick="switchGroup(2)">
                            <img src="images/english-group2.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>æ‰˜ç¦å¤‡è€ƒç¾¤</h4>
                                <p>æœ€æ–°ï¼šReading comprehension tips</p>
                            </div>
                            <span class="message-time">æ˜¨å¤©</span>
                        </div>
                        <div class="group-item" data-group-id="3" onclick="switchGroup(3)">
                            <img src="images/english-group3.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>å•†åŠ¡è‹±è¯­äº¤æµ</h4>
                                <p>æœ€æ–°ï¼šBusiness meeting expressions</p>
                            </div>
                            <span class="message-time">å‘¨ä¸€</span>
                        </div>
                        <div class="group-item" data-group-id="4" onclick="switchGroup(4)">
                            <img src="images/english-group4.png" alt="ç¾¤ç»„å¤´åƒ">
                            <div class="group-info">
                                <h4>è‹±æ–‡åŸç‰ˆé˜…è¯»</h4>
                                <p>æœ€æ–°ï¼šBook club meeting this weekend</p>
                            </div>
                            <span class="message-time">ä¸Šå‘¨</span>
                        </div>
                    </div>
                </aside>

                <!-- ä¸­é—´ç¾¤ç»„èŠå¤©åŒº -->
                <section class="group-list">
                    <div class="group-header">
                        <div class="group-switch-indicator" id="switchIndicator" style="display: none;">
                            <i class="fas fa-sync-alt"></i>
                            <span>åˆ‡æ¢ç¾¤ç»„ä¸­...</span>
                        </div>
                        <h2 id="currentGroupName">è‹±è¯­å£è¯­ç»ƒä¹ </h2>
                        <div class="group-stats">
                            <span class="member-count" id="currentMemberCount">æˆå‘˜: 36</span>
                            <button class="member-count" onclick="showGroupMembers()" style="cursor: pointer; background: var(--orange-gradient); color: white;">
                                <i class="fas fa-users"></i> æŸ¥çœ‹æˆå‘˜
                            </button>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <!-- ç³»ç»Ÿæ¶ˆæ¯ -->
                        <div class="system-message">
                            <div class="message-bubble">
                                <div class="message-text">Welcome to English Speaking Practice Group! ğŸŒŸ</div>
                            </div>
                        </div>

                        <!-- ä»–äººæ¶ˆæ¯1 -->
                        <div class="message-item other-message">
                            <div class="message-avatar">EN</div>
                            <div class="message-content-wrapper">
                                <div class="message-info">
                                    <span class="message-sender">English Learner</span>
                                    <span class="message-time">09:45</span>
                                </div>
                                <div class="message-bubble">
                                    <div class="message-text english-text">Good morning everyone! How was your weekend?</div>
                                    <div class="grammar-note">è¿‡å»å¼ç–‘é—®å¥</div>
                                </div>
                            </div>
                        </div>

                        <!-- ä»–äººæ¶ˆæ¯2 -->
                        <div class="message-item other-message">
                            <div class="message-avatar">TE</div>
                            <div class="message-content-wrapper">
                                <div class="message-info">
                                    <span class="message-sender">Teaching Assistant</span>
                                    <span class="message-time">09:48</span>
                                </div>
                                <div class="message-bubble">
                                    <div class="message-text english-text">My weekend was great! I watched an English movie and practiced listening skills.</div>
                                    <div class="grammar-note">è¿‡å»ç®€å•å¼ + å¹¶åˆ—å¥</div>
                                </div>
                            </div>
                        </div>

                        <!-- è‡ªå·±æ¶ˆæ¯ -->
                        <div class="message-item own-message">
                            <div class="message-avatar">ME</div>
                            <div class="message-content-wrapper">
                                <div class="message-info">
                                    <span class="message-sender">æˆ‘</span>
                                    <span class="message-time">09:50</span>
                                </div>
                                <div class="message-bubble">
                                    <div class="message-text english-text">I had a productive weekend too! I learned some new <span class="vocabulary-highlight">vocabulary</span> about travel.</div>
                                    <div class="grammar-note">å­¦ä¹ äº†ä¸€äº›å…³äºæ—…è¡Œçš„æ–°è¯æ±‡</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="message-input-area">
                        <div class="message-input-controls">
                            <button class="voice-btn" title="è¯­éŸ³è¾“å…¥">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="emoji-btn" title="è¡¨æƒ…ç¬¦å·">
                                <i class="fas fa-smile"></i>
                            </button>
                        </div>
                        <textarea class="message-input" placeholder="Try to write in English... (å°è¯•ç”¨è‹±è¯­è¾“å…¥)" id="messageInput"></textarea>
                        <button class="send-btn" id="sendBtn">å‘é€</button>
                    </div>
                </section>

                <!-- å³ä¾§ç¾¤ç»„ä¿¡æ¯ -->
                <aside class="group-info-sidebar">
                    <div class="group-info-header">
                        <button class="group-search-btn" onclick="searchInGroup()">
                            <i class="fas fa-search"></i> æŸ¥æ‰¾
                        </button>
                        <button class="group-files-btn" onclick="showGroupFiles()">
                            <i class="fas fa-file"></i> èµ„æ–™
                        </button>
                    </div>
                    <div class="group-info-content">
                        <div class="info-section">
                            <h3>ç¾¤ç»„ä¿¡æ¯</h3>
                            <div class="info-item">
                                <h4>ç¾¤åç§°</h4>
                                <p id="groupName">è‹±è¯­å£è¯­ç»ƒä¹ </p>
                            </div>
                            <div class="info-item">
                                <h4>ç¾¤ä»‹ç»</h4>
                                <p id="groupDescription">æ¯æ—¥è‹±è¯­å£è¯­ç»ƒä¹ ï¼Œæå‡æ²Ÿé€šèƒ½åŠ›ï¼Œæ¬¢è¿æ‰€æœ‰è‹±è¯­å­¦ä¹ è€…åŠ å…¥ï¼</p>
                            </div>
                            <div class="info-item">
                                <h4>ä»Šæ—¥è¯é¢˜</h4>
                                <p id="todayTopic">Travel and Transportation (æ—…è¡Œä¸äº¤é€š)</p>
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>åœ¨çº¿æˆå‘˜ <span id="onlineCount">(5)</span></h3>
                            <div class="member-list" id="onlineMembers">
                                <!-- åœ¨çº¿æˆå‘˜åˆ—è¡¨ä¼šé€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </div>
                        </div>
                        <div class="info-section">
                            <h3>å­¦ä¹ èµ„æº</h3>
                            <div class="member-list">
                                <div class="member-item" onclick="openResource('speaking')">
                                    <div class="member-avatar" style="background: #4CAF50; cursor: pointer;"><i class="fas fa-book"></i></div>
                                    <span class="member-name" style="cursor: pointer;">å£è¯­ç»ƒä¹ ç´ æ</span>
                                </div>
                                <div class="member-item" onclick="openResource('listening')">
                                    <div class="member-avatar" style="background: #2196F3; cursor: pointer;"><i class="fas fa-headphones"></i></div>
                                    <span class="member-name" style="cursor: pointer;">å¬åŠ›èµ„æºåº“</span>
                                </div>
                                <div class="member-item" onclick="openResource('video')">
                                    <div class="member-avatar" style="background: #FF9800; cursor: pointer;"><i class="fas fa-video"></i></div>
                                    <span class="member-name" style="cursor: pointer;">è§†é¢‘æ•™ç¨‹</span>
                                </div>
                            </div>
                        </div>
                        <div class="invite-code-section">
                            <div class="invite-code" onclick="copyInviteCode()">#ENGLISH789</div>
                            <button class="delete-group-btn" onclick="deleteCurrentGroup()">åˆ é™¤ç¾¤ç»„</button>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </main>

    <!-- ç§»åŠ¨ç«¯åˆ‡æ¢æŒ‰é’® -->
    <button class="mobile-toggle" id="mobileToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- æ’­æ”¾æ æ›¿æ¢ä¸º PlayBar.html ç‰ˆæœ¬ï¼ˆä»…æ›¿æ¢æ’­æ”¾æ ç›¸å…³åŒºåŸŸï¼Œå…¶ä½™ä¿æŒä¸å˜ï¼‰ -->
    <aside id="pv-player" class="pv-player-bar">
      <div class="pv-inner">
        <!-- å·¦ä¾§ï¼šå°é¢ä¸æ ‡é¢˜ï¼ˆæœ€å·¦ï¼‰ -->
        <div class="pv-left">
          <div id="pv-cover" class="pv-cover" role="button" tabindex="0" aria-label="æ‰“å¼€æ’­æ”¾é¡µé¢"></div>
          <div class="pv-meta">
            <div id="pv-title" class="pv-title" role="button" tabindex="0">Kalimba (Test Audio)</div>
            <div id="pv-artist" class="pv-artist">Ninja Tuna</div>
          </div>
        </div>

        <!-- ä¸­é—´ï¼šæ§åˆ¶ä¸è¿›åº¦ï¼ˆå±…ä¸­ï¼‰ -->
        <div class="pv-center">
          <div class="pv-controls">
            <button id="pv-prev" class="ctrl-btn" title="ä¸Šä¸€é¦–" aria-label="ä¸Šä¸€é¦–">
              <svg class="icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
            </button>
            <button id="pv-play" class="play-btn" title="æ’­æ”¾/æš‚åœ" aria-label="æ’­æ”¾/æš‚åœ">
              <svg id="play-icon" class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            </button>
            <button id="pv-next" class="ctrl-btn" title="ä¸‹ä¸€é¦–" aria-label="ä¸‹ä¸€é¦–">
              <svg class="icon" viewBox="0 0 24 24"><path d="M16 6h2v12h-2V6zM6 18l8.5-6L6 6v12z"/></svg>
            </button>

            <!-- å¾ªç¯æ¨¡å¼æŒ‰é’® + å¼¹å±‚ -->
            <div style="position: relative;">
              <button id="pv-mode-btn" class="mode-btn" title="æ’­æ”¾æ¨¡å¼" aria-label="æ’­æ”¾æ¨¡å¼">
                <svg class="icon" viewBox="0 0 24 24"><path d="M7 7h8v3l4-4-4-4v3H5v6h2V7zm10 10H9v-3l-4 4 4 4v-3h10v-6h-2v4z"/></svg>
              </button>
              <div id="mode-pop" class="popover mode-popover">
                <div class="mode-item active" data-mode="single" title="å•æ›²å¾ªç¯">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v4l-1.5-1.5C8 10 8 14 10.5 16.5S16 19 18.5 16.5L20 18c-3 3-8 3-11 0S6 9 9 6L12 5z"/></svg>
                </div>
                <div class="mode-item" data-mode="list" title="æ­Œå•é¡ºåºå¾ªç¯">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M4 6h12v2H4V6zm0 5h12v2H4v-2zm0 5h8v2H4v-2zm15-7l-3 3h2v4h2v-4h2l-3-3z"/></svg>
                </div>
                <div class="mode-item" data-mode="shuffle" title="æ­Œå•ä¹±åºå¾ªç¯">
                  <svg class="icon" viewBox="0 0 24 24"><path d="M16 3h5v5h-2V6.41l-4.29 4.3-1.42-1.42L17.59 5H16V3zM4 6h7l2 2H4V6zm0 6h5l2 2H4v-2zm12 3h1.59l-2.29 2.29 1.42 1.42L20 17.41V19h2v-5h-5v2z"/></svg>
                </div>
              </div>
            </div>

            <!-- å€é€ŸæŒ‰é’® + å¼¹å±‚ -->
            <div class="rate-control" style="position: relative;">
              <button id="pv-rate-btn" class="rate-btn" title="å€é€Ÿ"><span id="rate-text" style="font-size: 12px; font-weight: bold;">1x</span></button>
              <div id="rate-pop" class="popover rate-popover">
                <div class="rate-item" data-rate="0.5">0.5x</div>
                <div class="rate-item active" data-rate="1">1.0x</div>
                <div class="rate-item" data-rate="1.5">1.5x</div>
                <div class="rate-item" data-rate="2">2.0x</div>
              </div>
            </div>
          </div>

          <div class="pv-progress-row">
            <span id="pv-time-cur" class="time small">00:00</span>
            <div id="pv-progress" class="pv-progress">
              <div id="pv-progress-fill" class="pv-progress-fill"></div>
              <div id="pv-knob" class="pv-knob"></div>
            </div>
            <span id="pv-time-total" class="time small">00:00</span>
          </div>
        </div>

        <!-- å³ä¾§ï¼šéŸ³é‡ + æ­Œå•ï¼ˆæœ€å³ï¼‰ -->
        <div class="pv-right">
          <button id="pv-mute" class="ctrl-btn" title="é™éŸ³/å–æ¶ˆé™éŸ³" aria-label="é™éŸ³">
            <svg id="vol-icon" class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
          </button>
          <div id="pv-volume" class="pv-volume">
            <div class="pv-volume-bar"><div id="pv-volume-fill" class="pv-volume-fill"></div></div>
          </div>
          <button id="pv-list-btn" class="ctrl-btn" title="æ’­æ”¾åˆ—è¡¨" aria-label="æ’­æ”¾åˆ—è¡¨">
            <svg class="icon" viewBox="0 0 24 24"><path d="M3 5h18v2H3V5zm0 6h12v2H3v-2zm0 6h8v2H3v-2z"/></svg>
          </button>
        </div>
      </div>

      <!-- æ’­æ”¾åˆ—è¡¨å¼¹çª—ï¼ˆç¤ºä¾‹ï¼‰ -->
      <div id="playlist-panel" class="playlist-panel" style="display:none;">
        <div class="playlist-item active" onclick="playIndex(0)">1. Kalimba (Test)</div>
        <div class="playlist-item" onclick="playIndex(1)">2. Sample MP3 (Test)</div>
      </div>

      <audio id="pv-audio" preload="metadata"></audio>
    </aside>
    
    <!-- ç¾¤ç»„èŠå¤©è„šæœ¬ç»‘å®šï¼ˆå¯ç”¨åˆ‡æ¢ç¾¤ç»„ä¸å‘é€æ¶ˆæ¯ï¼‰ -->
    <script>
    (function(){
        // Ensure global ws from script.js exists and is connected via initWebSocket on DOMContentLoaded
        window.switchGroup = function(groupId){
            // UI switch: mark active list item
            document.querySelectorAll('.group-item').forEach(el=>el.classList.toggle('active', el.getAttribute('data-group-id')==groupId));
            // show loading indicator briefly
            const ind = document.getElementById('switchIndicator'); if(ind){ ind.style.display='flex'; setTimeout(()=>ind.style.display='none',500); }
            // fetch group info (placeholder)
            const nameEl = document.getElementById('currentGroupName'); if(nameEl) nameEl.textContent = document.querySelector(`.group-item[data-group-id="${groupId}"] .group-info h4`).textContent || 'ç¾¤ç»„';
            // update members count mock
            const memberCountEl = document.getElementById('currentMemberCount'); if(memberCountEl) memberCountEl.textContent = 'æˆå‘˜: ' + (30 + Number(groupId));
            // clear chat and load placeholder messages (in real app, fetch from /api/group/:id/messages)
            const chat = document.getElementById('chatMessages'); if(chat){ chat.innerHTML = ''; chat.appendChild((function(){ const sys = document.createElement('div'); sys.className='system-message'; sys.innerHTML = '<div class="message-bubble"><div class="message-text">å·²åˆ‡æ¢åˆ°ç¾¤ç»„ '+groupId+'</div></div>'; return sys; })()); }
        };

        const sendBtn = document.getElementById('sendBtn');
        const messageInput = document.getElementById('messageInput');

        function sendMessage(){
            const text = (messageInput.value||'').trim(); if(!text) return;
            // prefer existing global ws if available
            if(window.ws && window.ws.readyState === WebSocket.OPEN){
                const uid = (window.currentUser && window.currentUser.id) ? window.currentUser.id : (typeof currentUser !== 'undefined' && currentUser.id ? currentUser.id : ('anon_' + Math.random().toString(36).slice(2,8)));
                window.ws.send(JSON.stringify({ type:'comment', userId: uid, content: text, timestamp: Date.now() }));
            } else {
                // fallback: append locally
                const chat = document.getElementById('chatMessages'); if(chat){ const el = document.createElement('div'); el.className='message-item own-message'; el.innerHTML = `<div class="message-avatar">ME</div><div class="message-content-wrapper"><div class="message-info"><span class="message-sender">æˆ‘</span><span class="message-time">${new Date().toLocaleTimeString()}</span></div><div class="message-bubble"><div class="message-text">${text}</div></div></div>`; chat.appendChild(el); chat.scrollTop = chat.scrollHeight; }
            }
            messageInput.value = '';
        }

        if(sendBtn){ sendBtn.addEventListener('click', sendMessage); }
        if(messageInput){ messageInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } }); }

        // copy invite code
        window.copyInviteCode = function(){ const codeEl = document.querySelector('.invite-code'); if(!codeEl) return; const text = codeEl.textContent || codeEl.innerText; navigator.clipboard && navigator.clipboard.writeText(text).then(()=>{ showNotification('é‚€è¯·ç å·²å¤åˆ¶'); }).catch(()=>{ alert('å¤åˆ¶å¤±è´¥ï¼š'+text); }); };

        window.showGroupMembers = function(){ const listEl = document.getElementById('onlineMembers'); if(!listEl) return; listEl.innerHTML = ''; for(let i=1;i<=5;i++){ const item = document.createElement('div'); item.className='member-item'; item.innerHTML = `<div class="member-avatar online">U${i}</div><span class="member-name">æˆå‘˜${i}</span>`; listEl.appendChild(item); } };

        // basic delete stub
        window.deleteCurrentGroup = function(){ if(confirm('ç¡®è®¤åˆ é™¤å½“å‰ç¾¤ç»„ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€')){ showNotification('ç¾¤ç»„å·²åˆ é™¤ï¼ˆæ¨¡æ‹Ÿï¼‰'); } };
    })();
    </script>

    <script>
        // è‹±è¯­å­¦ä¹ ç¾¤ç»„æ•°æ®ï¼ˆåŸåŠŸèƒ½ä¿ç•™ï¼‰
        const groupData = {
            1: {
                name: "è‹±è¯­å£è¯­ç»ƒä¹ ",
                description: "æ¯æ—¥è‹±è¯­å£è¯­ç»ƒä¹ ï¼Œæå‡æ²Ÿé€šèƒ½åŠ›ï¼Œæ¬¢è¿æ‰€æœ‰è‹±è¯­å­¦ä¹ è€…åŠ å…¥ï¼",
                memberCount: 36,
                messages: [
                    { sender: "ç³»ç»Ÿ", text: "Welcome to English Speaking Practice Group! ğŸŒŸ", time: "09:30", isSystem: true },
                    { sender: "English Learner", avatar: "EN", text: "Good morning everyone! How was your weekend?", time: "09:45", isOwn: false, englishText: true, grammarNote: "è¿‡å»å¼ç–‘é—®å¥" },
                    { sender: "Teaching Assistant", avatar: "TE", text: "My weekend was great! I watched an English movie and practiced listening skills.", time: "09:48", isOwn: false, englishText: true, grammarNote: "è¿‡å»ç®€å•å¼ + å¹¶åˆ—å¥" },
                    { sender: "æˆ‘", avatar: "ME", text: "I had a productive weekend too! I learned some new vocabulary about travel.", time: "09:50", isOwn: true, englishText: true, vocabulary: ["vocabulary"] }
                ],
                onlineMembers: ["English Learner", "Teaching Assistant", "Fluency Master", "Grammar Guru", "IELTS Expert"],
                allMembers: ["English Learner", "Teaching Assistant", "Fluency Master", "Grammar Guru", "IELTS Expert", "TOEFL Student", "Business English", "Conversation Partner"],
                unreadCount: 8,
                todayTopic: "Travel and Transportation (æ—…è¡Œä¸äº¤é€š)"
            },
            2: {
                name: "æ‰˜ç¦å¤‡è€ƒç¾¤",
                description: "æ‰˜ç¦è€ƒè¯•å¤‡è€ƒäº¤æµï¼Œåˆ†äº«å­¦ä¹ ç»éªŒå’Œå¤‡è€ƒæŠ€å·§",
                memberCount: 28,
                messages: [
                    { sender: "ç³»ç»Ÿ", text: "TOEFLå¤‡è€ƒå°ç»„ - äº’ç›¸é¼“åŠ±ï¼Œå…±åŒè¿›æ­¥ï¼", time: "æ˜¨å¤© 14:20", isSystem: true },
                    { sender: "TOEFL Master", avatar: "TM", text: "Has anyone taken the TOEFL reading section recently? Any tips?", time: "æ˜¨å¤© 14:35", isOwn: false, englishText: true },
                    { sender: "æˆ‘", avatar: "ME", text: "I find that skimming the questions first really helps with time management.", time: "æ˜¨å¤© 15:10", isOwn: true, englishText: true, vocabulary: ["skimming", "time management"] }
                ],
                onlineMembers: ["TOEFL Master", "Reading Expert", "Listening Pro"],
                allMembers: ["TOEFL Master", "Reading Expert", "Listening Pro", "Writing Coach", "Speaking Tutor"],
                unreadCount: 3,
                todayTopic: "Reading Comprehension Strategies"
            },
            3: {
                name: "å•†åŠ¡è‹±è¯­äº¤æµ",
                description: "å•†åŠ¡è‹±è¯­å­¦ä¹ ä¸å®è·µï¼Œæå‡èŒåœºè‹±è¯­èƒ½åŠ›",
                memberCount: 22,
                messages: [
                    { sender: "Business Pro", avatar: "BP", text: "How to professionally decline a meeting invitation?", time: "å‘¨ä¸€ 10:30", isOwn: false, englishText: true },
                    { sender: "æˆ‘", avatar: "ME", text: "You can say: 'Thank you for the invitation, but I have a scheduling conflict.'", time: "å‘¨ä¸€ 11:15", isOwn: true, englishText: true, vocabulary: ["scheduling conflict"] }
                ],
                onlineMembers: ["Business Pro", "Corporate Trainer", "Negotiation Expert"],
                allMembers: ["Business Pro", "Corporate Trainer", "Negotiation Expert", "Presentation Coach", "Email Specialist"],
                unreadCount: 1,
                todayTopic: "Business Meeting Expressions"
            },
            4: {
                name: "è‹±æ–‡åŸç‰ˆé˜…è¯»",
                description: "è‹±æ–‡åŸè‘—é˜…è¯»åˆ†äº«ï¼Œæé«˜é˜…è¯»ç†è§£å’Œè¯æ±‡é‡",
                memberCount: 45,
                messages: [
                    { sender: "Bookworm", avatar: "BW", text: "Just finished 'The Great Gatsby'. The symbolism is fascinating!", time: "ä¸Šå‘¨äº” 16:20", isOwn: false, englishText: true, vocabulary: ["symbolism"] },
                    { sender: "æˆ‘", avatar: "ME", text: "I'm currently reading '1984'. The political themes are very thought-provoking.", time: "ä¸Šå‘¨äº” 16:45", isOwn: true, englishText: true, vocabulary: ["thought-provoking"] }
                ],
                onlineMembers: ["Bookworm", "Literature Lover", "Vocabulary Builder"],
                allMembers: ["Bookworm", "Literature Lover", "Vocabulary Builder", "Classic Reader", "Modern Fiction Fan"],
                unreadCount: 0,
                todayTopic: "Literary Analysis Techniques"
            }
        };

        let currentGroupId = 1;

        function initializePage() {
            const urlParams = new URLSearchParams(window.location.search);
            const groupIdFromUrl = urlParams.get('groupId') || urlParams.get('group');
            if (groupIdFromUrl) {
                if (groupData[groupIdFromUrl]) {
                    currentGroupId = isNaN(groupIdFromUrl) ? groupIdFromUrl : parseInt(groupIdFromUrl);
                    loadGroupData(currentGroupId);
                    setupEventListeners();
                    return;
                }
                fetch('/api/group/' + encodeURIComponent(groupIdFromUrl)).then(res => {
                    if (res.ok) return res.json();
                    throw new Error('no-data');
                }).then(json => {
                    const id = groupIdFromUrl;
                    groupData[id] = {
                        name: json.name || ('ç¾¤ç»„ ' + id),
                        description: json.desc || json.description || '',
                        memberCount: json.members || json.memberCount || 1,
                        messages: json.messages || [{ sender: 'ç³»ç»Ÿ', text: 'å·²è¿›å…¥ç¾¤ç»„', time: new Date().toLocaleTimeString(), isSystem: true }],
                        onlineMembers: json.onlineMembers || [],
                        allMembers: json.allMembers || [],
                        unreadCount: json.unreadCount || 0,
                        todayTopic: json.todayTopic || ''
                    };
                    currentGroupId = id;
                    loadGroupData(currentGroupId);
                    setupEventListeners();
                }).catch(() => {
                    if (window.sampleGroups && Array.isArray(window.sampleGroups)) {
                        const found = window.sampleGroups.find(g => String(g.id) === String(groupIdFromUrl));
                        if (found) {
                            groupData[groupIdFromUrl] = {
                                name: found.name,
                                description: found.desc || '',
                                memberCount: found.members || 1,
                                messages: [{ sender: 'ç³»ç»Ÿ', text: 'å ä½ç¾¤ç»„ï¼ˆæ¥è‡ªæœ¬åœ°ï¼‰', time: new Date().toLocaleTimeString(), isSystem: true }],
                                onlineMembers: [], allMembers: [], unreadCount: 0, todayTopic: ''
                            };
                            currentGroupId = groupIdFromUrl;
                            loadGroupData(currentGroupId);
                            setupEventListeners();
                            return;
                        }
                    }
                    const id = groupIdFromUrl;
                    groupData[id] = { name: 'ç¾¤ç»„ ' + id, description: 'æš‚æ— æè¿°', memberCount: 1, messages: [{ sender: 'ç³»ç»Ÿ', text: 'å ä½ç¾¤ç»„', time: new Date().toLocaleTimeString(), isSystem: true }], onlineMembers: [], allMembers: [], unreadCount: 0, todayTopic: '' };
                    currentGroupId = id;
                    loadGroupData(currentGroupId);
                    setupEventListeners();
                });
                return;
            }
            loadGroupData(currentGroupId);
            setupEventListeners();
        }

        function showSwitchIndicator() {
            const indicator = document.getElementById('switchIndicator');
            indicator.style.display = 'flex';
            setTimeout(() => { indicator.style.display = 'none'; }, 2000);
        }

        function switchGroup(groupId) {
            if (groupId !== currentGroupId) {
                currentGroupId = groupId;
                loadGroupData(groupId);
                const newUrl = window.location.pathname + '?groupId=' + encodeURIComponent(groupId);
                window.history.pushState({ groupId: groupId }, '', newUrl);
            }
        }

        function highlightVocabulary(text, vocabulary) {
            if (!vocabulary || vocabulary.length === 0) return text;
            let highlightedText = text;
            vocabulary.forEach(word => {
                const regex = new RegExp(`\\b${word}\\b`, 'gi');
                highlightedText = highlightedText.replace(regex, `<span class="vocabulary-highlight">${word}</span>`);
            });
            return highlightedText;
        }

        function loadGroupData(groupId) {
            const group = groupData[groupId];
            if (!group) return;

            showSwitchIndicator();

            document.getElementById('currentGroupName').textContent = group.name;
            document.getElementById('currentMemberCount').textContent = `æˆå‘˜: ${group.memberCount}`;
            document.getElementById('groupName').textContent = group.name;
            document.getElementById('groupDescription').textContent = group.description;
            document.getElementById('todayTopic').textContent = group.todayTopic;

            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = '';

            group.messages.forEach(message => {
                let messageElement;
                if (message.isSystem) {
                    messageElement = document.createElement('div');
                    messageElement.className = 'system-message';
                    messageElement.innerHTML = `
                        <div class="message-bubble">
                            <div class="message-text">${message.text}</div>
                        </div>
                    `;
                } else {
                    messageElement = document.createElement('div');
                    messageElement.className = `message-item ${message.isOwn ? 'own-message' : 'other-message'}`;
                    const shortName = message.avatar || message.sender.substring(0, 2);
                    const englishClass = message.englishText ? 'english-text' : '';
                    const bilingualClass = message.bilingual ? 'bilingual-text' : '';
                    const textClass = `${englishClass} ${bilingualClass}`.trim();
                    let processedText = message.text;
                    if (message.vocabulary) processedText = highlightVocabulary(message.text, message.vocabulary);
                    let grammarNoteHTML = message.grammarNote ? `<div class="grammar-note">${message.grammarNote}</div>` : '';
                    messageElement.innerHTML = `
                        <div class="message-avatar">${shortName}</div>
                        <div class="message-content-wrapper">
                            <div class="message-info">
                                <span class="message-sender">${message.sender}</span>
                                <span class="message-time">${message.time}</span>
                            </div>
                            <div class="message-bubble">
                                <div class="message-text ${textClass}">${processedText}</div>
                                ${grammarNoteHTML}
                            </div>
                        </div>
                    `;
                }
                chatMessages.appendChild(messageElement);
            });

            chatMessages.scrollTop = chatMessages.scrollHeight;

            const onlineMembers = document.getElementById('onlineMembers');
            onlineMembers.innerHTML = '';
            document.getElementById('onlineCount').textContent = `(${group.onlineMembers.length})`;
            group.onlineMembers.forEach(member => {
                const shortName = member.substring(0, 2);
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <div class="member-avatar online">${shortName}</div>
                    <span class="member-name">${member}</span>
                `;
                memberElement.addEventListener('click', () => {
                    window.location.href = `user-profile.html?username=${encodeURIComponent(member)}`;
                });
                onlineMembers.appendChild(memberElement);
            });

            updateGroupListActiveState(groupId);
        }

        function addAvatarClickEvents() {
            const messageAvatars = document.querySelectorAll('.message-avatar');
            messageAvatars.forEach(avatar => {
                avatar.style.cursor = 'pointer';
                avatar.addEventListener('click', function() {
                    window.location.href = 'user-profile.html';
                });
            });

            const memberAvatars = document.querySelectorAll('.member-avatar');
            memberAvatars.forEach(avatar => {
                avatar.style.cursor = 'pointer';
                avatar.addEventListener('click', function() {
                    window.location.href = 'user-profile.html';
                });
            });
        }

        function updateGroupListActiveState(activeGroupId) {
            const desktopItems = document.querySelectorAll('.group-items .group-item');
            desktopItems.forEach(item => {
                const groupIdAttr = item.getAttribute('data-group-id');
                const isActive = String(groupIdAttr) === String(activeGroupId);
                const group = groupData[groupIdAttr] || groupData[Number(groupIdAttr)];
                if (isActive) {
                    item.classList.add('active');
                    if (group && group.unreadCount > 0) {
                        group.unreadCount = 0;
                        const countElement = item.querySelector('.message-count');
                        if (countElement) countElement.remove();
                    }
                } else {
                    item.classList.remove('active');
                    if (group && group.unreadCount > 0) {
                        let countElement = item.querySelector('.message-count');
                        if (!countElement) {
                            countElement = document.createElement('span');
                            countElement.className = 'message-count';
                            item.appendChild(countElement);
                        }
                        countElement.textContent = group.unreadCount;
                    } else {
                        const countElement = item.querySelector('.message-count');
                        if (countElement) countElement.remove();
                    }
                }
            });

            const mobileItems = document.querySelectorAll('.group-list-mobile .group-item');
            mobileItems.forEach(item => {
                const groupIdAttr = item.getAttribute('data-group-id');
                const isActive = String(groupIdAttr) === String(activeGroupId);
                const group = groupData[groupIdAttr] || groupData[Number(groupIdAttr)];
                if (isActive) {
                    item.classList.add('active');
                    if (group && group.unreadCount > 0) {
                        group.unreadCount = 0;
                        const countElement = item.querySelector('.message-count');
                        if (countElement) countElement.remove();
                    }
                } else {
                    item.classList.remove('active');
                    if (group && group.unreadCount > 0) {
                        let countElement = item.querySelector('.message-count');
                        if (!countElement) {
                            countElement = document.createElement('span');
                            countElement.className = 'message-count';
                            item.appendChild(countElement);
                        }
                        countElement.textContent = group.unreadCount;
                    }
                }
            });
        }

        function setupEventListeners() {
            const groupSearch = document.getElementById('groupSearch');
            groupSearch.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const groupItems = document.querySelectorAll('.group-item');
                groupItems.forEach(item => {
                    const groupName = item.querySelector('.group-info h4').textContent.toLowerCase();
                    const groupDesc = item.querySelector('.group-info p').textContent.toLowerCase();
                    item.style.display = (groupName.includes(searchTerm) || groupDesc.includes(searchTerm)) ? 'flex' : 'none';
                });
            });

            window.showGroupMembers = function() {
                const group = groupData[currentGroupId];
                alert(`ç¾¤ç»„ ${group.name} çš„æ‰€æœ‰æˆå‘˜ï¼š\n${group.allMembers.join(', ')}`);
            };

            window.openResource = function(resourceType) {
                const resourceNames = { 'speaking': 'å£è¯­ç»ƒä¹ ç´ æ', 'listening': 'å¬åŠ›èµ„æºåº“', 'video': 'è§†é¢‘æ•™ç¨‹' };
                alert(`æ­£åœ¨æ‰“å¼€ ${resourceNames[resourceType]}...`);
            };

            window.searchInGroup = function() {
                const searchTerm = prompt('åœ¨ç¾¤èŠä¸­æœç´¢ï¼š');
                if (searchTerm) alert(`æ­£åœ¨æœç´¢ï¼š"${searchTerm}"\nåŠŸèƒ½å¼€å‘ä¸­...`);
            };

            window.showGroupFiles = function() { alert('ç¾¤æ–‡ä»¶åŠŸèƒ½å¼€å‘ä¸­...'); };

            window.deleteCurrentGroup = function() {
                if (confirm('ç¡®å®šè¦åˆ é™¤å½“å‰ç¾¤ç»„å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
                    delete groupData[currentGroupId];
                    document.querySelectorAll('.group-items .group-item').forEach(item => {
                        const groupId = parseInt(item.getAttribute('data-group-id'));
                        if (groupId === currentGroupId) item.remove();
                    });
                    document.querySelectorAll('.group-list-mobile .group-item').forEach(item => {
                        const groupId = parseInt(item.getAttribute('data-group-id'));
                        if (groupId === currentGroupId) item.remove();
                    });
                    const remainingGroupIds = Object.keys(groupData).map(id => parseInt(id));
                    if (remainingGroupIds.length > 0) switchGroup(remainingGroupIds[0]);
                    else alert('æ‰€æœ‰ç¾¤ç»„å·²åˆ é™¤ï¼');
                }
                
                // æ·»åŠ å¤´åƒç‚¹å‡»äº‹ä»¶
                addAvatarClickEvents();
            }
        }

        function copyInviteCode() {
            const inviteCodeEl = document.querySelector('.invite-code');
            const inviteCode = inviteCodeEl.textContent;
            navigator.clipboard.writeText(inviteCode).then(() => {
                const originalText = inviteCodeEl.textContent;
                inviteCodeEl.textContent = 'Copied! (å·²å¤åˆ¶)';
                setTimeout(() => { inviteCodeEl.textContent = originalText; }, 2000);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            initializePage();

            const mobileToggle = document.getElementById('mobileToggle');
            const channelSidebar = document.querySelector('.channel-sidebar');
            const groupInfoSidebar = document.querySelector('.group-info-sidebar');
            const groupList = document.querySelector('.group-list');
            let toggleState = 0;

            mobileToggle.addEventListener('click', function() {
                toggleState = (toggleState + 1) % 3;
                if (toggleState === 0) {
                    channelSidebar.style.display = 'none';
                    groupInfoSidebar.style.display = 'none';
                    groupList.style.display = 'block';
                    mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
                } else if (toggleState === 1) {
                    channelSidebar.style.display = 'block';
                    groupInfoSidebar.style.display = 'none';
                    groupList.style.display = 'none';
                    mobileToggle.innerHTML = '<i class="fas fa-comments"></i>';
                } else {
                    channelSidebar.style.display = 'none';
                    groupInfoSidebar.style.display = 'block';
                    groupList.style.display = 'none';
                    mobileToggle.innerHTML = '<i class="fas fa-user-friends"></i>';
                }
            });

            // å‘é€æ¶ˆæ¯
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            function sendMessage() {
                const text = messageInput.value.trim();
                if (text) {
                    const newMessage = {
                        sender: "æˆ‘",
                        avatar: "ME",
                        text,
                        time: new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' }),
                        isOwn: true,
                        englishText: /[a-zA-Z]/.test(text),
                        bilingual: /[\u4e00-\u9fa5]/.test(text) && /[a-zA-Z]/.test(text)
                    };
                    if (groupData[currentGroupId]) {
                        groupData[currentGroupId].messages.push(newMessage);
                        loadGroupData(currentGroupId);
                        messageInput.value = '';
                        setTimeout(() => {
                            const autoReplies = [
                                { sender: "AI Tutor", avatar: "AI", text: "Great effort! Remember to use complete sentences.", englishText: true },
                                { sender: "Language Partner", avatar: "LP", text: "Good job! I understood your message clearly.", englishText: true },
                                { sender: "Grammar Checker", avatar: "GC", text: "Nice try! Pay attention to verb tenses.", englishText: true }
                            ];
                            const randomReply = autoReplies[Math.floor(Math.random() * autoReplies.length)];
                            randomReply.time = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                            randomReply.isOwn = false;
                            groupData[currentGroupId].messages.push(randomReply);
                            loadGroupData(currentGroupId);
                        }, 1000);
                    }
                }
            }

            window.addEventListener('popstate', function(event) {
                if (event.state && event.state.groupId) {
                    currentGroupId = event.state.groupId;
                    loadGroupData(currentGroupId);
                }
            });
        });

        // åˆ›å»ºç¾¤ç»„æ¨¡æ€æ¡†ï¼ˆåŸæ ·ä¿ç•™ï¼‰
        const createGroupModal = document.createElement('div');
        createGroupModal.className = 'modal-overlay';
        createGroupModal.style.display = 'none';
        createGroupModal.innerHTML = `
            <div class="modal">
                <div class="modal-header">
                    <h2 class="modal-title">åˆ›å»ºå­¦ä¹ ç¾¤ç»„</h2>
                    <button class="close-btn">&times;</button>
                </div>
                <div class="modal-content">
                    <div class="form-group">
                        <label for="groupName">ç¾¤ç»„åç§°</label>
                        <input type="text" id="groupName" placeholder="è¯·è¾“å…¥ç¾¤ç»„åç§°" required>
                    </div>
                    <div class="form-group">
                        <label for="groupDescription">ç¾¤ç»„æè¿°</label>
                        <textarea id="groupDescription" placeholder="è¯·è¾“å…¥ç¾¤ç»„æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel">å–æ¶ˆ</button>
                    <button class="btn-create">åˆ›å»º</button>
                </div>
            </div>
        `;
        document.body.appendChild(createGroupModal);

        document.getElementById('createGroupBtn').addEventListener('click', function() {
            createGroupModal.style.display = 'flex';
        });
        createGroupModal.querySelector('.close-btn').addEventListener('click', function() {
            createGroupModal.style.display = 'none';
        });
        createGroupModal.querySelector('.btn-cancel').addEventListener('click', function() {
            createGroupModal.style.display = 'none';
        });
        createGroupModal.addEventListener('click', function(e) {
            if (e.target === createGroupModal) {
                createGroupModal.style.display = 'none';
            }
        });
        createGroupModal.querySelector('.btn-create').addEventListener('click', function() {
            const groupName = createGroupModal.querySelector('#groupName').value;
            const groupDescription = createGroupModal.querySelector('#groupDescription').value;
            if (groupName) {
                const newGroupId = 'group_' + Date.now();
                groupData[newGroupId] = {
                    name: groupName,
                    description: groupDescription,
                    memberCount: 3,
                    messages: [
                        { sender: "ç³»ç»Ÿ", text: `æ¬¢è¿åŠ å…¥ ${groupName} ç¾¤ç»„ï¼ğŸŒŸ`, time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}), isSystem: true }
                    ],
                    onlineMembers: ['æ‚¨', 'å…¶ä»–æˆå‘˜1', 'å…¶ä»–æˆå‘˜2'],
                    allMembers: ['æ‚¨', 'å…¶ä»–æˆå‘˜1', 'å…¶ä»–æˆå‘˜2'],
                    unreadCount: 1,
                    todayTopic: "æš‚æ— è¯é¢˜"
                };

                const avatarId = Math.floor(Math.random() * 4) + 1;
                const avatarSrc = `images/english-group${avatarId}.png`;
                const groupItemHTML = `
                    <img src="${avatarSrc}" alt="ç¾¤ç»„å¤´åƒ">
                    <div class="group-info">
                        <h4>${groupName}</h4>
                        <p>${groupDescription || 'æš‚æ— æè¿°'}</p>
                    </div>
                `;
                const mobileGroupList = document.querySelector('.group-list-mobile');
                if (mobileGroupList) {
                    const newMobileGroupItem = document.createElement('div');
                    newMobileGroupItem.className = 'group-item';
                    newMobileGroupItem.setAttribute('onclick', `switchGroup('${newGroupId}')`);
                    newMobileGroupItem.innerHTML = groupItemHTML;
                    mobileGroupList.appendChild(newMobileGroupItem);
                }
                const desktopGroupItems = document.querySelector('.group-items');
                if (desktopGroupItems) {
                    const newDesktopGroupItem = document.createElement('div');
                    newDesktopGroupItem.className = 'group-item';
                    newDesktopGroupItem.setAttribute('onclick', `switchGroup('${newGroupId}')`);
                    newDesktopGroupItem.innerHTML = groupItemHTML;
                    desktopGroupItems.appendChild(newDesktopGroupItem);
                }
                createGroupModal.style.display = 'none';
            } else {
                alert('è¯·è¾“å…¥ç¾¤ç»„åç§°');
            }
        });
    </script>

    <!-- PlayBar äº¤äº’è„šæœ¬ï¼šæ›¿æ¢ä¸º PlayBar.html å®Œæ•´ç‰ˆæœ¬ï¼Œä»…æ›¿æ¢æ’­æ”¾å™¨ç›¸å…³è„šæœ¬ -->
    <script>
;(function () {
/* ä¸¤ä¸ªæ ·ä¾‹éŸ³é¢‘ */
const playlist = [
  { title: "Kalimba (Test Audio)", artist: "Ninja Tuna", cover: "", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3" },
  { title: "Sample MP3 (700KB)", artist: "Sample Source", cover: "", src: "https://sample.cat/downloads/file_example_MP3_700KB.mp3" }
];

let currentIndex = 0;
let isPlaying = false;
let isDraggingProgress = false;
let isDraggingVolume = false;
let playMode = 'list'; /* single | list | shuffle */

const audio = document.getElementById('pv-audio');
const playBtn = document.getElementById('pv-play');
const playIcon = document.getElementById('play-icon');
const prevBtn = document.getElementById('pv-prev');
const nextBtn = document.getElementById('pv-next');
const titleEl = document.getElementById('pv-title');
const artistEl = document.getElementById('pv-artist');
const coverEl = document.getElementById('pv-cover');
const progressEl = document.getElementById('pv-progress');
const progressFill = document.getElementById('pv-progress-fill');
const knobEl = document.getElementById('pv-knob');
const timeCurEl = document.getElementById('pv-time-cur');
const timeTotalEl = document.getElementById('pv-time-total');
const volEl = document.getElementById('pv-volume');
const volFill = document.getElementById('pv-volume-fill');
const listBtn = document.getElementById('pv-list-btn');
const playlistPanel = document.getElementById('playlist-panel');
const rateBtn = document.getElementById('pv-rate-btn');
const rateText = document.getElementById('rate-text');
const muteBtn = document.getElementById('pv-mute');
const volIcon = document.getElementById('vol-icon');
const modeBtn = document.getElementById('pv-mode-btn');
const modePop = document.getElementById('mode-pop');
const ratePop = document.getElementById('rate-pop');

function loadTrack(index) {
  const track = playlist[index];
  titleEl.innerText = track.title;
  artistEl.innerText = track.artist;
  coverEl.style.backgroundImage = track.cover ? `url('${track.cover}')` : '';
  audio.src = track.src;
  document.querySelectorAll('.playlist-item').forEach((item, i) => item.classList.toggle('active', i === index));
}
function playTrack() { audio.play().then(() => { isPlaying = true; updatePlayIcon(); }).catch(err => console.error("Play failed:", err)); }
function pauseTrack() { audio.pause(); isPlaying = false; updatePlayIcon(); }
function togglePlay() { isPlaying ? pauseTrack() : playTrack(); }
function updatePlayIcon() {
  if (isPlaying) { playIcon.setAttribute('viewBox','0 0 24 24'); playIcon.innerHTML = '<path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/>'; }
  else { playIcon.setAttribute('viewBox','0 0 24 24'); playIcon.innerHTML = '<path d="M8 5v14l11-7z"/>'; }
}
function formatTime(s) { if (!s || isNaN(s)) return "00:00"; const m = Math.floor(s/60), ss = Math.floor(s%60); return `${m<10?'0':''}${m}:${ss<10?'0':''}${ss}`; }
function stopWrap(handler) { return function(e){ e.stopPropagation(); handler(e); }; }

/* æ§ä»¶äº‹ä»¶ï¼ˆé˜»æ­¢å†’æ³¡ï¼‰ */
playBtn.addEventListener('click', stopWrap(togglePlay));
prevBtn.addEventListener('click', stopWrap(() => prevByMode()));
nextBtn.addEventListener('click', stopWrap(() => nextByMode()));
muteBtn.addEventListener('click', stopWrap(() => {
  audio.muted = !audio.muted;
  if (audio.muted || audio.volume === 0) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 3l7 7-1.4 1.4L16 7.8V16h-2V8.6L9.4 4 11 2.4 14 3z"/>'; }
  else if (audio.volume < 0.5) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 9v6c1.7-0.7 3-2.4 3-4.5S15.7 9.7 14 9z"/>'; }
  else { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 7v10c3-1 5-3.6 5-7s-2-6-5-7z"/>'; }
}));

/* æ¨¡å¼å¼¹å±‚ */
modeBtn.addEventListener('click', stopWrap(() => {
  ratePop.classList.remove('show');
  modePop.classList.toggle('show');
}));
modePop.addEventListener('click', stopWrap((e) => {
  const item = e.target.closest('.mode-item');
  if (!item) return;
  playMode = item.getAttribute('data-mode');
  document.querySelectorAll('#mode-pop .mode-item').forEach(el => el.classList.toggle('active', el === item));
  modePop.classList.remove('show');
}));

/* å€é€Ÿå¼¹å±‚ */
rateBtn.addEventListener('click', stopWrap(() => {
  modePop.classList.remove('show');
  ratePop.classList.toggle('show');
}));
ratePop.addEventListener('click', stopWrap((e) => {
  const item = e.target.closest('.rate-item');
  if (!item) return;
  const r = parseFloat(item.getAttribute('data-rate'));
  audio.playbackRate = r;
  rateText.innerText = r.toFixed(1) + 'x';
  document.querySelectorAll('#rate-pop .rate-item').forEach(el => el.classList.toggle('active', el === item));
  ratePop.classList.remove('show');
}));

/* ç‚¹å‡»å…¶ä»–åŒºåŸŸå…³é—­å¼¹å±‚ */
document.addEventListener('click', (e) => {
  if (!modeBtn.contains(e.target) && !modePop.contains(e.target)) modePop.classList.remove('show');
  if (!rateBtn.contains(e.target) && !ratePop.contains(e.target)) ratePop.classList.remove('show');
});

/* éŸ³é¢‘äº‹ä»¶ä¸åˆ‡æ­Œæ¨¡å¼ */
audio.addEventListener('timeupdate', () => {
  if (isDraggingProgress) return;
  const percent = (audio.currentTime / audio.duration) * 100;
  progressFill.style.width = `${percent}%`;
  knobEl.style.left = `${percent}%`;
  timeCurEl.innerText = formatTime(audio.currentTime);
});
audio.addEventListener('loadedmetadata', () => { timeTotalEl.innerText = formatTime(audio.duration); });
audio.addEventListener('ended', () => {
  if (playMode === 'single') { audio.currentTime = 0; playTrack(); }
  else { nextByMode(); }
});
function prevByMode() {
  if (playMode === 'shuffle') currentIndex = Math.floor(Math.random() * playlist.length);
  else currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
  loadTrack(currentIndex); playTrack();
}
function nextByMode() {
  if (playMode === 'shuffle') currentIndex = Math.floor(Math.random() * playlist.length);
  else currentIndex = (currentIndex + 1) % playlist.length;
  loadTrack(currentIndex); playTrack();
}

/* è¿›åº¦æ¡æ‹–æ‹½ï¼ˆé¼ æ ‡/è§¦æ‘¸ï¼‰ */
function handleProgressInput(clientX) {
  const rect = progressEl.getBoundingClientRect();
  let x = clientX - rect.left; x = Math.max(0, Math.min(x, rect.width));
  const pct = (x / rect.width) * 100; progressFill.style.width = `${pct}%`; knobEl.style.left = `${pct}%`;
  return (x / rect.width) * audio.duration;
}
progressEl.addEventListener('mousedown', stopWrap((e) => { isDraggingProgress = true; progressEl.classList.add('dragging'); const t = handleProgressInput(e.clientX); timeCurEl.innerText = formatTime(t); }));
document.addEventListener('mousemove', (e) => { if (isDraggingProgress) { e.preventDefault(); const t = handleProgressInput(e.clientX); timeCurEl.innerText = formatTime(t); } });
document.addEventListener('mouseup', (e) => { if (isDraggingProgress) { isDraggingProgress = false; progressEl.classList.remove('dragging'); const t = handleProgressInput(e.clientX); if (isFinite(t)) audio.currentTime = t; } });

function getTouchX(e){ return (e.touches&&e.touches[0]) ? e.touches[0].clientX : (e.changedTouches&&e.changedTouches[0] ? e.changedTouches[0].clientX : 0); }
progressEl.addEventListener('touchstart', (e) => { e.stopPropagation(); e.preventDefault(); isDraggingProgress = true; const t = handleProgressInput(getTouchX(e)); timeCurEl.innerText = formatTime(t); }, { passive:false });
document.addEventListener('touchmove', (e) => { if (isDraggingProgress) { e.preventDefault(); const t = handleProgressInput(getTouchX(e)); timeCurEl.innerText = formatTime(t); } }, { passive:false });
document.addEventListener('touchend', (e) => { if (isDraggingProgress) { isDraggingProgress = false; const t = handleProgressInput(getTouchX(e)); if (isFinite(t)) audio.currentTime = t; } }, { passive:false });

/* éŸ³é‡æ‹–æ‹½ï¼ˆé¼ æ ‡/è§¦æ‘¸ï¼‰ */
function handleVolumeInput(clientX) {
  const rect = volEl.getBoundingClientRect();
  let x = clientX - rect.left; x = Math.max(0, Math.min(x, rect.width));
  const p = x / rect.width; volFill.style.width = `${p * 100}%`; audio.volume = p;
  if (p === 0 || audio.muted) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 3l7 7-1.4 1.4L16 7.8V16h-2V8.6L9.4 4 11 2.4 14 3z"/>'; }
  else if (p < 0.5) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 9v6c1.7-0.7 3-2.4 3-4.5S15.7 9.7 14 9z"/>'; }
  else { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 7v10c3-1 5-3.6 5-7s-2-6-5-7z"/>'; }
}
volEl.addEventListener('mousedown', stopWrap((e) => { isDraggingVolume = true; handleVolumeInput(e.clientX); }));
document.addEventListener('mousemove', (e) => { if (isDraggingVolume) { e.preventDefault(); handleVolumeInput(e.clientX); } });
document.addEventListener('mouseup', () => { isDraggingVolume = false; });
volEl.addEventListener('touchstart', (e) => { e.stopPropagation(); e.preventDefault(); isDraggingVolume = true; handleVolumeInput(getTouchX(e)); }, { passive:false });
document.addEventListener('touchmove', (e) => { if (isDraggingVolume) { e.preventDefault(); handleVolumeInput(getTouchX(e)); } }, { passive:false });
document.addEventListener('touchend', () => { isDraggingVolume = false; }, { passive:false });

/* ç®€æ˜“æ’­æ”¾åˆ—è¡¨å¼€å…³ï¼ˆç¤ºä¾‹ï¼‰ */
listBtn.addEventListener('click', stopWrap(() => {
  playlistPanel.style.display = playlistPanel.style.display === 'block' ? 'none' : 'block';
}));

/* æä¾›ç»™ HTML çš„æ’­æ”¾åˆ—è¡¨åˆ‡æ¢ */
window.playIndex = function(index){ currentIndex = index; loadTrack(currentIndex); playTrack(); }

/* æ–°å¢ï¼šå½“ç”¨æˆ·ç‚¹å‡»å°é¢æˆ–æ ‡é¢˜æ—¶ï¼Œè·³è½¬åˆ° player.html å¹¶æºå¸¦å½“å‰ playlist å’Œç´¢å¼•ä¿¡æ¯ */
function openPlayerPageWithData(openInNewTab = false) {
  try {
    const params = new URLSearchParams();
    params.set('course', titleEl.innerText || '');
    params.set('chapterIndex', String(currentIndex || 0));
    const safePlaylist = playlist.map((p, i) => ({
      id: p.id || ('p' + i),
      title: p.title || (`Track ${i+1}`),
      src: p.src || '',
      duration: p.durationText || p.duration || ''
    }));
    params.set('chapters', encodeURIComponent(JSON.stringify(safePlaylist)));
    const url = 'player.html?' + params.toString();
    if (openInNewTab) window.open(url, '_blank');
    else window.location.href = url;
  } catch (err) {
    try {
      const params = new URLSearchParams();
      params.set('course', titleEl.innerText || '');
      params.set('chapterIndex', String(currentIndex || 0));
      const url = 'player.html?' + params.toString();
      if (openInNewTab) window.open(url, '_blank');
      else window.location.href = url;
    } catch (_) { /* ignore */ }
  }
}

/* ç»™å°é¢ä¸æ ‡é¢˜ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼ˆæ”¯æŒé”®ç›˜å›è½¦ï¼‰ */
if (coverEl) {
  coverEl.addEventListener('click', stopWrap(() => openPlayerPageWithData(false)));
  coverEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPlayerPageWithData(false); } });
}
if (titleEl) {
  titleEl.addEventListener('click', stopWrap(() => openPlayerPageWithData(false)));
  titleEl.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); openPlayerPageWithData(false); } });
}

/* åˆå§‹åŒ–ç¬¬ä¸€é¦– */
loadTrack(currentIndex);
})();
    </script>
</body>
</html>