<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>上传音频 - 星之声</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="../js/search.js"></script>
    <script src="../js/auth.js"></script>
    <style>
        /* 继承主站风格 - 橙色主题 */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background-color: #ffffff;
            color: #333;
            min-height: 100vh;
            margin: 0;
            padding-top: 70px; /* 给顶部导航栏留空间 */
            padding-bottom: 96px; /* 为播放栏预留空间 */
        }

        /* 上传容器 */
        .upload-container {
            max-width: 800px;
            margin: 0 auto 60px;
            padding: 30px;
            background-color: #fff8f0;
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.1);
            border: 1px solid #ffe0b2;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #e65100; /* 深橙色 */
            font-size: 28px;
            font-weight: 600;
        }

        /* 表单组 */
        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ff6d00; /* 橙色 */
            font-size: 15px;
        }

        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #ffcc80;
            border-radius: 10px;
            font-size: 15px;
            box-sizing: border-box;
            transition: all 0.2s ease;
            background-color: #fff8e1; /* 浅橙色背景 */
        }

        input[type="text"]:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #ff9800;
            background-color: white;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
        }

        textarea {
            height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        /* 文件上传区域 */
        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            position: absolute;
            left: 0;
            top: 0;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-label {
            display: block;
            padding: 15px 20px;
            background-color: #fff3e0; /* 浅橙色 */
            color: #ff6d00;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 15px;
            border: 2px dashed #ffb74d;
        }

        .file-input-label:hover {
            background-color: #ffecb3;
            border-color: #ff9800;
        }

        /* 文件信息显示 */
        .file-info {
            background-color: #fff8e1;
            border-left: 3px solid #ff9800;
            padding: 15px;
            margin-top: 15px;
            border-radius: 8px;
            display: none;
        }

        .file-info p {
            margin: 6px 0;
            font-size: 14px;
            color: #555;
        }

        /* 音频预览 */
        .audio-preview {
            margin: 25px 0;
            display: none;
        }

        .audio-preview audio {
            width: 100%;
            border-radius: 10px;
            background-color: #fff3e0;
        }

        /* 进度条 */
        .progress-container {
            width: 100%;
            height: 20px;
            background-color: #ffe0b2;
            border-radius: 10px;
            margin: 25px 0;
            display: none;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff9800 0%, #ff5722 100%); /* 橙色渐变 */
            border-radius: 10px;
            width: 0%;
            transition: width 0.3s ease;
        }

        /* 上传进度文本 */
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
        }

        /* 按钮组 */
        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 35px;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); /* 橙色渐变 */
            color: white;
        }

        .btn-primary:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(255, 152, 0, 0.3);
        }

        .btn-secondary {
            background-color: #fff3e0;
            color: #ff6d00;
            border: 1px solid #ffcc80;
        }

        .btn-secondary:hover {
            background-color: #ffecb3;
        }

        /* 消息提示 */
        .message {
            padding: 16px 20px;
            margin-bottom: 25px;
            border-radius: 10px;
            display: none;
            font-weight: 500;
        }

        .message.success {
            background-color: #f1f8e9;
            border-left: 4px solid #8bc34a;
            color: #33691e;
        }

        .message.error {
            background-color: #ffebee;
            border-left: 4px solid #f44336;
            color: #b71c1c;
        }

        .message.info {
            background-color: #fff8e1;
            border-left: 4px solid #ff9800;
            color: #e65100;
        }

        /* 创建合集表单 */
        #create-group-form {
            margin-top: 25px;
            padding: 25px;
            background-color: #fff8e1;
            border-radius: 10px;
            display: none;
            border: 1px solid #ffcc80;
        }

        #create-group-form h3 {
            margin-bottom: 20px;
            color: #e65100;
            font-size: 18px;
            font-weight: 600;
        }

        /* 橙色选择器样式 */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='%23ff9800'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        /* 响应式调整 */
        @media (max-width: 768px) {
            .upload-container {
                margin: 0 20px 60px;
                padding: 20px;
            }

            h1 {
                font-size: 24px;
            }

            .btn-group {
                flex-direction: column;
            }
        }

        /* 模态框样式 */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            margin: 0 auto;
            position: relative;
            animation: modalFadeIn 0.3s ease;
        }

        .modal-content {
            padding: 30px;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* 橙色占位符 */
        ::placeholder {
            color: #ffab91;
            opacity: 0.7;
        }

        /* 上传进度条样式（页面内使用） */
        .progress-container {
            width: 100%;
            height: 6px;
            background-color: #fff3e0;
            border-radius: 3px;
            overflow: hidden;
            margin: 15px 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background-color: #ff8c00;
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .progress-text {
            position: absolute;
            right: 0;
            top: -25px;
            color: #ff8c00;
            font-size: 14px;
            font-weight: 500;
        }

        /* PlayBar 样式（来自 PlayBar.html） */
        .pv-player-bar {
          position: fixed; left: 0; right: 0; bottom: 0;
          width: 100%; height: 96px; background: #ffffff;
          border-top: 1px solid #e0e0e0; box-shadow: 0 -4px 20px rgba(0,0,0,0.08);
          z-index: 29999; display: flex; align-items: center; user-select: none; pointer-events: auto;
        }
        .pv-inner {
          width: 100%; max-width: 1200px; margin: 0 auto;
          display: grid; grid-template-columns: auto 1fr auto; align-items: center;
          column-gap: 16px; padding: 0 24px; height: 100%;
        }
        .pv-left { display: inline-flex; align-items: center; gap: 12px; min-width: 240px; }
        .pv-cover { width: 52px; height: 52px; border-radius: 8px; background: #eee no-repeat center/cover; box-shadow: 0 2px 6px rgba(0,0,0,0.1); flex-shrink: 0; }
        .pv-meta { display: flex; flex-direction: column; min-width: 0; }
        .pv-title { font-size: 16px; font-weight: 700; color: #222; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pv-artist { font-size: 12px; color: #666; margin-top: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .pv-center { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; min-width: 0; }
        .pv-controls { display: inline-flex; align-items: center; gap: 18px; }
        .ctrl-btn, .mode-btn, .rate-btn { background: transparent; border: none; cursor: pointer; color: #444; font-size: 18px; padding: 6px; display: inline-flex; align-items: center; justify-content: center; transition: color 0.2s; }
        .ctrl-btn:hover, .mode-btn:hover, .rate-btn:hover { color: #ff8c00; }
        .play-btn { width: 44px; height: 44px; border-radius: 50%; background: #ff8c00; color: #fff; border: none; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(255,140,0,0.30); transition: transform 0.1s, background 0.2s; }
        .play-btn:hover { background: #e67e00; transform: scale(1.05); }
        .icon { width: 18px; height: 18px; fill: currentColor; }
        .pv-progress-row { display: flex; align-items: center; gap: 12px; width: 100%; }
        .time.small { font-size: 12px; color: #888; width: 48px; text-align: center; font-variant-numeric: tabular-nums; }
        .pv-progress { position: relative; flex: 1; height: 6px; background: #eee; border-radius: 3px; cursor: pointer; touch-action: none; }
        .pv-progress-fill { position: absolute; left: 0; top: 0; bottom: 0; background: #ff8c00; border-radius: 3px; width: 0%; pointer-events: none; }
        .pv-knob { position: absolute; top: 50%; right: -6px; transform: translateY(-50%); width: 12px; height: 12px; background: #fff; border: 2px solid #ff8c00; border-radius: 50%; box-shadow: 0 1px 4px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        .pv-right { display: inline-flex; align-items: center; justify-content: flex-end; gap: 12px; min-width: 240px; }
        .pv-volume { width: 140px; height: 20px; display: flex; align-items: center; cursor: pointer; position: relative; }
        .pv-volume-bar { width: 100%; height: 4px; background: #eee; border-radius: 2px; position: relative; overflow: visible; pointer-events: none; }
        .pv-volume-fill { height: 100%; background: #888; width: 50%; border-radius: 2px; position: relative; }
        .playlist-panel { background:#fff; border:1px solid #eee; border-radius:8px; box-shadow:0 8px 30px rgba(0,0,0,0.12); overflow:auto; padding:8px; position:absolute; bottom:110px; right:24px; display:none; }
        .playlist-item { padding:8px 12px; cursor:pointer; }
        .playlist-item.active { background:#fff3e0; color:#ff8c00; font-weight:600; }
        @media (max-width: 900px) { .pv-left{min-width:0;} .pv-right{min-width:0;} .pv-inner{grid-template-columns:auto 1fr auto; column-gap:10px; padding:0 12px;} }
    </style>
</head>
<body>
<!-- 音频元素 -->
<audio id="audioPlayer" controls style="display: none;">
    <source src="" type="audio/mpeg">
    您的浏览器不支持音频播放
</audio>

<!-- 顶部导航栏 -->
<header class="header">
    <div class="logo">
        <div class="logo-img"></div>
        <span class="logo-text">星之声</span>
    </div>
    <nav class="main-nav">
        <a href="index.html" class="nav-item">首页</a>
        <a href="category.html" class="nav-item">分类</a>
        <a href="channel.html" class="nav-item">社区</a>
    </nav>
    <div class="search-box">
        <input type="text" placeholder="搜索课程、频道..." class="search-input" id="homeSearchInput">
        <button class="search-btn" id="homeSearchBtn"><i class="fas fa-search"></i></button>
    </div>
    <div class="user-functions">
        <a href="my-recent.html" class="func-item">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </a>
        <a href="my-message.html" class="func-item"><i class="fas fa-bell"></i> 消息</a>
        <a href="my-collect.html" class="func-item"><i class="fas fa-star"></i> 收藏</a>
        <a href="my-recent.html" class="func-item"><i class="fas fa-history"></i> 历史</a>
        <a href="my-creator_center.html" class="func-item"><i class="fas fa-pen"></i> 创作中心</a>
        <a href="login.html"><button class="submit-btn">登录/注册</button></a>
    </div>
</header>

<!-- 上传内容区域 -->
<main class="main-content">
    <div class="upload-container">
        <h1>上传音频</h1>

        <!-- 消息显示区域 -->
        <div id="message" class="message"></div>

        <form id="upload-form">
            <!-- 文件选择 -->
            <div class="form-group">
                <label for="audio-file">选择音频文件</label>
                <div class="file-input-wrapper">
                    <input type="file" id="audio-file" accept="audio/mp3,audio/aac,audio/m4a" class="file-input" required>
                    <span class="file-input-label">选择音频文件</span>
                </div>

                <!-- 文件信息显示 -->
                <div id="file-info" class="file-info">
                    <p><strong>文件名：</strong><span id="file-name"></span></p>
                    <p><strong>文件大小：</strong><span id="file-size"></span></p>
                    <p><strong>时长：</strong><span id="file-duration"></span></p>
                </div>

                <!-- 音频预览 -->
                <div id="audio-preview" class="audio-preview">
                    <audio id="audio-player" controls></audio>
                </div>
            </div>

            <!-- 音频标题 -->
            <div class="form-group">
                <label for="audio-title">音频标题</label>
                <input type="text" id="audio-title" placeholder="请输入音频标题" required>
            </div>

            <!-- 音频描述 -->
            <div class="form-group">
                <label for="audio-description">音频描述</label>
                <textarea id="audio-description" placeholder="请输入音频描述"></textarea>
            </div>

            <!-- 合集选择 -->
            <div class="form-group">
                <label for="audio-group">选择合集</label>
                <select id="audio-group">
                    <option value="">不添加到任何合集</option>
                    <!-- 动态加载合集列表 -->
                </select>
            </div>

            <!-- 模态框容器 -->
            <div id="modal-overlay" class="modal-overlay">
                <div id="create-group-modal" class="modal">
                    <div class="modal-content">
                        <h3>创建新合集</h3>
                        <div class="form-group">
                            <label for="new-group-name">合集名称</label>
                            <input type="text" id="new-group-name" placeholder="请输入合集名称">
                        </div>
                        <div class="form-group">
                            <label for="new-group-desc">合集描述</label>
                            <textarea id="new-group-desc" placeholder="请输入合集描述"></textarea>
                        </div>
                        <div class="btn-group">
                            <button type="button" id="submit-create-group" class="btn btn-primary">创建</button>
                            <button type="button" id="cancel-create-group" class="btn btn-secondary">取消</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 上传进度 -->
            <div id="upload-progress-container" class="progress-container">
                <div id="upload-progress-fill" class="progress-fill"></div>
                <span id="upload-progress-text" class="progress-text">0%</span>
            </div>

            <!-- 表单按钮 -->
            <div class="btn-group">
                <button type="submit" class="btn btn-primary">上传</button>
                <button type="button" id="reset-btn" class="btn btn-secondary">重置</button>
            </div>
        </form>
    </div>
</main>

<!-- 使用 PlayBar.html 的播放栏（替换原有 footer 播放栏） -->
<aside id="pv-player" class="pv-player-bar" role="region" aria-label="播放器">
  <div class="pv-inner">
    <!-- 左侧：封面与标题 -->
    <div class="pv-left">
      <div id="pv-cover" class="pv-cover"></div>
      <div class="pv-meta">
        <div id="pv-title" class="pv-title">Kalimba (Test Audio)</div>
        <div id="pv-artist" class="pv-artist">Ninja Tuna</div>
      </div>
    </div>

    <!-- 中间：控制与进度 -->
    <div class="pv-center">
      <div class="pv-controls">
        <button id="pv-prev" class="ctrl-btn" title="上一首" aria-label="上一首">
          <svg class="icon" viewBox="0 0 24 24"><path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/></svg>
        </button>
        <button id="pv-play" class="play-btn" title="播放/暂停" aria-label="播放/暂停">
          <svg id="play-icon" class="icon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
        </button>
        <button id="pv-next" class="ctrl-btn" title="下一首" aria-label="下一首">
          <svg class="icon" viewBox="0 0 24 24"><path d="M16 6h2v12h-2V6zM6 18l8.5-6L6 6v12z"/></svg>
        </button>

        <!-- 播放模式 -->
        <div style="position: relative;">
          <button id="pv-mode-btn" class="mode-btn" title="播放模式" aria-label="播放模式">
            <svg class="icon" viewBox="0 0 24 24"><path d="M7 7h8v3l4-4-4-4v3H5v6h2V7zm10 10H9v-3l-4 4 4 4v-3h10v-6h-2v4z"/></svg>
          </button>
          <div id="mode-pop" class="popover mode-popover" style="display:none;">
            <div class="mode-item active" data-mode="single" title="单曲循环">
              <svg class="icon" viewBox="0 0 24 24"><path d="M12 5v4l-1.5-1.5C8 10 8 14 10.5 16.5S16 19 18.5 16.5L20 18c-3 3-8 3-11 0S6 9 9 6L12 5z"/></svg>
            </div>
            <div class="mode-item" data-mode="list" title="歌单顺序循环">
              <svg class="icon" viewBox="0 0 24 24"><path d="M4 6h12v2H4V6zm0 5h12v2H4v-2zm0 5h8v2H4v-2zm15-7l-3 3h2v4h2v-4h2l-3-3z"/></svg>
            </div>
            <div class="mode-item" data-mode="shuffle" title="歌单乱序循环">
              <svg class="icon" viewBox="0 0 24 24"><path d="M16 3h5v5h-2V6.41l-4.29 4.3-1.42-1.42L17.59 5H16V3zM4 6h7l2 2H4V6zm0 6h5l2 2H4v-2zm12 3h1.59l-2.29 2.29 1.42 1.42L20 17.41V19h2v-5h-5v2z"/></svg>
            </div>
          </div>
        </div>

        <!-- 倍速 -->
        <div class="rate-control" style="position: relative;">
          <button id="pv-rate-btn" class="rate-btn" title="倍速"><span id="rate-text" style="font-size: 12px; font-weight: bold;">1x</span></button>
          <div id="rate-pop" class="popover rate-popover" style="display:none;">
            <div class="rate-item" data-rate="0.5">0.5x</div>
            <div class="rate-item active" data-rate="1">1.0x</div>
            <div class="rate-item" data-rate="1.5">1.5x</div>
            <div class="rate-item" data-rate="2">2.0x</div>
          </div>
        </div>
      </div>

      <div class="pv-progress-row">
        <span id="pv-time-cur" class="time small">00:00</span>
        <div id="pv-progress" class="pv-progress">
          <div id="pv-progress-fill" class="pv-progress-fill"></div>
          <div id="pv-knob" class="pv-knob"></div>
        </div>
        <span id="pv-time-total" class="time small">00:00</span>
      </div>
    </div>

    <!-- 右侧：音量 -->
    <div class="pv-right">
      <button id="pv-mute" class="ctrl-btn" title="静音/取消静音" aria-label="静音">
        <svg id="vol-icon" class="icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3z"/></svg>
      </button>
      <div id="pv-volume" class="pv-volume" title="音量">
        <div class="pv-volume-bar"><div id="pv-volume-fill" class="pv-volume-fill"></div></div>
      </div>
      <button id="pv-list-btn" class="ctrl-btn" title="播放列表" aria-label="播放列表">▤</button>
    </div>
  </div>

  <!-- 播放列表弹窗（示例） -->
  <div id="playlist-panel" class="playlist-panel">
    <div class="playlist-item active" onclick="playIndex(0)">1. Kalimba (Test)</div>
    <div class="playlist-item" onclick="playIndex(1)">2. Sample MP3 (Test)</div>
  </div>

  <audio id="pv-audio" preload="metadata"></audio>
</aside>

<!-- 页面功能 JavaScript（上传相关逻辑保留） -->
<script>
    const fileInput = document.getElementById('audio-file');
    const fileInfo = document.getElementById('file-info');
    const fileNameEl = document.getElementById('file-name');
    const fileSizeEl = document.getElementById('file-size');
    const fileDurationEl = document.getElementById('file-duration');
    const previewContainer = document.getElementById('audio-preview');
    const previewAudio = document.getElementById('audio-player');

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        fileInfo.style.display = 'block';
        fileNameEl.textContent = file.name;
        fileSizeEl.textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';

        // 预览
        const url = URL.createObjectURL(file);
        previewAudio.src = url;
        previewContainer.style.display = 'block';

        await previewAudio.play().catch(()=>{});
        previewAudio.pause();

        previewAudio.addEventListener('loadedmetadata', () => {
            const duration = previewAudio.duration || 0;
            const min = Math.floor(duration / 60);
            const sec = Math.floor(duration % 60);
            fileDurationEl.textContent = `${String(min).padStart(2,'0')}:${String(sec).padStart(2,'0')}`;
        }, { once: true });
    });

    // 简单的上传表单模拟（保留占位）
    const uploadForm = document.getElementById('upload-form');
    const progressContainer = document.getElementById('upload-progress-container');
    const progressFill = document.getElementById('upload-progress-fill');
    const progressText = document.getElementById('upload-progress-text');
    const msgBox = document.getElementById('message');
    const resetBtn = document.getElementById('reset-btn');

    uploadForm.addEventListener('submit', (e) => {
        e.preventDefault();
        msgBox.className = 'message info';
        msgBox.textContent = '开始上传...';
        msgBox.style.display = 'block';

        progressContainer.style.display = 'block';
        let p = 0;
        const timer = setInterval(() => {
            p = Math.min(100, p + Math.floor(Math.random() * 15) + 5);
            progressFill.style.width = p + '%';
            progressText.textContent = p + '%';
            if (p >= 100) {
                clearInterval(timer);
                msgBox.className = 'message success';
                msgBox.textContent = '上传成功！';
            }
        }, 500);
    });

    resetBtn.addEventListener('click', () => {
        uploadForm.reset();
        fileInfo.style.display = 'none';
        previewContainer.style.display = 'none';
        progressContainer.style.display = 'none';
        progressFill.style.width = '0%';
        progressText.textContent = '0%';
        msgBox.style.display = 'none';
    });
</script>

<!-- PlayBar 业务脚本（来自 PlayBar.html） -->
<script>
;(function () {
  const playlist = [
    { title: "Kalimba (Test Audio)", artist: "Ninja Tuna", cover: "", src: "https://www.learningcontainer.com/wp-content/uploads/2020/02/Kalimba.mp3" },
    { title: "Sample MP3 (700KB)", artist: "Sample Source", cover: "", src: "https://sample.cat/downloads/file_example_MP3_700KB.mp3" }
  ];

  let currentIndex = 0;
  let isPlaying = false;
  let isDraggingProgress = false;
  let isDraggingVolume = false;
  let playMode = 'list'; /* single | list | shuffle */

  const audio = document.getElementById('pv-audio');
  const playBtn = document.getElementById('pv-play');
  const playIcon = document.getElementById('play-icon');
  const prevBtn = document.getElementById('pv-prev');
  const nextBtn = document.getElementById('pv-next');
  const titleEl = document.getElementById('pv-title');
  const artistEl = document.getElementById('pv-artist');
  const coverEl = document.getElementById('pv-cover');
  const progressEl = document.getElementById('pv-progress');
  const progressFill = document.getElementById('pv-progress-fill');
  const knobEl = document.getElementById('pv-knob');
  const timeCurEl = document.getElementById('pv-time-cur');
  const timeTotalEl = document.getElementById('pv-time-total');
  const volEl = document.getElementById('pv-volume');
  const volFill = document.getElementById('pv-volume-fill');
  const listBtn = document.getElementById('pv-list-btn');
  const playlistPanel = document.getElementById('playlist-panel');
  const rateBtn = document.getElementById('pv-rate-btn');
  const rateText = document.getElementById('rate-text');
  const muteBtn = document.getElementById('pv-mute');
  const volIcon = document.getElementById('vol-icon');
  const modeBtn = document.getElementById('pv-mode-btn');
  const modePop = document.getElementById('mode-pop');
  const ratePop = document.getElementById('rate-pop');

  function loadTrack(index) {
    const track = playlist[index];
    titleEl.innerText = track.title;
    artistEl.innerText = track.artist;
    coverEl.style.backgroundImage = track.cover ? `url('${track.cover}')` : '';
    audio.src = track.src;
    document.querySelectorAll('.playlist-item').forEach((item, i) => item.classList.toggle('active', i === index));
  }
  function playTrack() { audio.play().then(() => { isPlaying = true; updatePlayIcon(); }).catch(err => console.error("Play failed:", err)); }
  function pauseTrack() { audio.pause(); isPlaying = false; updatePlayIcon(); }
  function togglePlay() { isPlaying ? pauseTrack() : playTrack(); }
  function updatePlayIcon() {
    playIcon.setAttribute('viewBox','0 0 24 24');
    playIcon.innerHTML = isPlaying ? '<path d="M6 5h4v14H6V5zm8 0h4v14h-4V5z"/>' : '<path d="M8 5v14l11-7z"/>';
  }
  function formatTime(s) { if (!s || isNaN(s)) return "00:00"; const m = Math.floor(s/60), ss = Math.floor(s%60); return `${m<10?'0':''}${m}:${ss<10?'0':''}${ss}`; }
  function stopWrap(handler) { return function(e){ e.stopPropagation(); handler(e); }; }

  playBtn.addEventListener('click', stopWrap(togglePlay));
  prevBtn.addEventListener('click', stopWrap(() => prevByMode()));
  nextBtn.addEventListener('click', stopWrap(() => nextByMode()));
  muteBtn.addEventListener('click', stopWrap(() => {
    audio.muted = !audio.muted;
    if (audio.muted || audio.volume === 0) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 3l7 7-1.4 1.4L16 7.8V16h-2V8.6L9.4 4 11 2.4 14 3z"/>'; }
    else if (audio.volume < 0.5) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 9v6c1.7-0.7 3-2.4 3-4.5S15.7 9.7 14 9z"/>'; }
    else { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 7v10c3-1 5-3.6 5-7s-2-6-5-7z"/>'; }
  }));

  modeBtn.addEventListener('click', stopWrap(() => {
    ratePop.style.display = 'none';
    modePop.style.display = modePop.style.display === 'flex' ? 'none' : 'flex';
  }));
  modePop.addEventListener('click', stopWrap((e) => {
    const item = e.target.closest('.mode-item');
    if (!item) return;
    playMode = item.getAttribute('data-mode');
    document.querySelectorAll('#mode-pop .mode-item').forEach(el => el.classList.toggle('active', el === item));
    modePop.style.display = 'none';
  }));

  rateBtn.addEventListener('click', stopWrap(() => {
    modePop.style.display = 'none';
    ratePop.style.display = ratePop.style.display === 'flex' ? 'none' : 'flex';
  }));
  ratePop.addEventListener('click', stopWrap((e) => {
    const item = e.target.closest('.rate-item');
    if (!item) return;
    const r = parseFloat(item.getAttribute('data-rate'));
    audio.playbackRate = r;
    rateText.innerText = r.toFixed(1) + 'x';
    document.querySelectorAll('#rate-pop .rate-item').forEach(el => el.classList.toggle('active', el === item));
    ratePop.style.display = 'none';
  }));

  document.addEventListener('click', (e) => {
    if (!modeBtn.contains(e.target) && !modePop.contains(e.target)) modePop.style.display = 'none';
    if (!rateBtn.contains(e.target) && !ratePop.contains(e.target)) ratePop.style.display = 'none';
  });

  audio.addEventListener('timeupdate', () => {
    if (isDraggingProgress) return;
    const percent = (audio.currentTime / audio.duration) * 100;
    progressFill.style.width = `${percent}%`;
    knobEl.style.left = `${percent}%`;
    timeCurEl.innerText = formatTime(audio.currentTime);
  });
  audio.addEventListener('loadedmetadata', () => { timeTotalEl.innerText = formatTime(audio.duration); });
  audio.addEventListener('ended', () => {
    if (playMode === 'single') { audio.currentTime = 0; playTrack(); }
    else { nextByMode(); }
  });
  function prevByMode() {
    if (playMode === 'shuffle') currentIndex = Math.floor(Math.random() * playlist.length);
    else currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
    loadTrack(currentIndex); playTrack();
  }
  function nextByMode() {
    if (playMode === 'shuffle') currentIndex = Math.floor(Math.random() * playlist.length);
    else currentIndex = (currentIndex + 1) % playlist.length;
    loadTrack(currentIndex); playTrack();
  }

  function handleProgressInput(clientX) {
    const rect = progressEl.getBoundingClientRect();
    let x = clientX - rect.left; x = Math.max(0, Math.min(x, rect.width));
    const pct = (x / rect.width) * 100; progressFill.style.width = `${pct}%`; knobEl.style.left = `${pct}%`;
    return (x / rect.width) * audio.duration;
  }
  progressEl.addEventListener('mousedown', stopWrap((e) => { isDraggingProgress = true; progressEl.classList.add('dragging'); const t = handleProgressInput(e.clientX); timeCurEl.innerText = formatTime(t); }));
  document.addEventListener('mousemove', (e) => { if (isDraggingProgress) { e.preventDefault(); const t = handleProgressInput(e.clientX); timeCurEl.innerText = formatTime(t); } });
  document.addEventListener('mouseup', (e) => { if (isDraggingProgress) { isDraggingProgress = false; progressEl.classList.remove('dragging'); const t = handleProgressInput(e.clientX); if (isFinite(t)) audio.currentTime = t; } });

  function getTouchX(e){ return (e.touches&&e.touches[0]) ? e.touches[0].clientX : (e.changedTouches&&e.changedTouches[0] ? e.changedTouches[0].clientX : 0); }
  progressEl.addEventListener('touchstart', (e) => { e.stopPropagation(); e.preventDefault(); isDraggingProgress = true; const t = handleProgressInput(getTouchX(e)); timeCurEl.innerText = formatTime(t); }, { passive:false });
  document.addEventListener('touchmove', (e) => { if (isDraggingProgress) { e.preventDefault(); const t = handleProgressInput(getTouchX(e)); timeCurEl.innerText = formatTime(t); } }, { passive:false });
  document.addEventListener('touchend', (e) => { if (isDraggingProgress) { isDraggingProgress = false; const t = handleProgressInput(getTouchX(e)); if (isFinite(t)) audio.currentTime = t; } }, { passive:false });

  function handleVolumeInput(clientX) {
    const rect = volEl.getBoundingClientRect();
    let x = clientX - rect.left; x = Math.max(0, Math.min(x, rect.width));
    const p = x / rect.width; volFill.style.width = `${p * 100}%`; audio.volume = p;
    if (p === 0 || audio.muted) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 3l7 7-1.4 1.4L16 7.8V16h-2V8.6L9.4 4 11 2.4 14 3z"/>'; }
    else if (p < 0.5) { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 9v6c1.7-0.7 3-2.4 3-4.5S15.7 9.7 14 9z"/>'; }
    else { volIcon.innerHTML = '<path d="M3 9v6h4l5 5V4L7 9H3zM14 7v10c3-1 5-3.6 5-7s-2-6-5-7z"/>'; }
  }
  volEl.addEventListener('mousedown', stopWrap((e) => { isDraggingVolume = true; handleVolumeInput(e.clientX); }));
  document.addEventListener('mousemove', (e) => { if (isDraggingVolume) { e.preventDefault(); handleVolumeInput(e.clientX); } });
  document.addEventListener('mouseup', () => { isDraggingVolume = false; });
  volEl.addEventListener('touchstart', (e) => { e.stopPropagation(); e.preventDefault(); isDraggingVolume = true; handleVolumeInput(getTouchX(e)); }, { passive:false });
  document.addEventListener('touchmove', (e) => { if (isDraggingVolume) { e.preventDefault(); handleVolumeInput(getTouchX(e)); } }, { passive:false });
  document.addEventListener('touchend', () => { isDraggingVolume = false; }, { passive:false });

  listBtn.addEventListener('click', stopWrap(() => {
    playlistPanel.style.display = playlistPanel.style.display === 'block' ? 'none' : 'block';
  }));

  window.playIndex = function(index){ currentIndex = index; loadTrack(currentIndex); playTrack(); }

  loadTrack(currentIndex);
})();
</script>

<script src="../js/upload-audio.js"></script>
</body>
</html>